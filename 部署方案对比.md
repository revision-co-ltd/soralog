# 🔄 部署方案对比

本文档对比了三种主要的部署方案，帮助你选择最适合的部署策略。

---

## 📊 方案对比总览

| 特性 | 方案A：Vercel + Railway | 方案B：全Vercel | 方案C：全Railway |
|------|------------------------|----------------|-----------------|
| **难度** | ⭐⭐ 简单 | ⭐⭐⭐⭐ 复杂 | ⭐ 最简单 |
| **性能** | ⭐⭐⭐⭐⭐ 最快 | ⭐⭐⭐⭐ 快 | ⭐⭐⭐ 良好 |
| **成本** | 💰💰 中等 | 💰💰💰 较高 | 💰 最低 |
| **维护** | ⭐⭐⭐ 中等 | ⭐⭐ 简单 | ⭐⭐⭐⭐ 最简单 |
| **推荐度** | ⭐⭐⭐⭐⭐ 强烈推荐 | ⭐⭐⭐ 推荐 | ⭐⭐⭐⭐ 推荐 |

---

## 🎯 方案A：Vercel（前端）+ Railway（后端）

### 架构
```
前端 → Vercel（全球CDN）
后端 → Railway（Docker容器）
数据库 → Supabase/Neon（云数据库）
```

### 优点
✅ **前端超快**：Vercel全球CDN，加载速度最快  
✅ **无需修改代码**：Express后端直接部署  
✅ **可扩展性强**：前后端独立扩展  
✅ **开发体验好**：两个平台都有优秀的Dashboard  
✅ **自动HTTPS**：两个平台都自动提供SSL证书  

### 缺点
❌ **管理两个平台**：需要在两个地方配置环境变量  
❌ **需要配置CORS**：跨域请求需要正确配置  
❌ **成本较高**：两个平台都可能产生费用  

### 适用场景
- ✅ 需要最佳性能
- ✅ 预期流量较大
- ✅ 团队有一定技术经验
- ✅ 前后端需要独立部署和扩展

### 详细步骤

#### 1. 部署后端到Railway

```bash
# 访问 https://railway.app
# 使用GitHub登录
# 选择 "Deploy from GitHub repo"
# 连接你的仓库
```

**环境变量配置：**
```
DATABASE_URL=postgresql://user:pass@host:5432/db
JWT_SECRET=your-secret-key
PORT=3000
NODE_ENV=production
CORS_ORIGIN=https://your-app.vercel.app
```

**服务配置：**
- Start Command: `npm run backend`
- Build Command: `npm install && npx prisma generate`

#### 2. 部署前端到Vercel

```bash
# 访问 https://vercel.com
# 使用GitHub登录
# Import你的仓库
```

**环境变量配置：**
```
VITE_API_URL=https://your-backend.railway.app/api
```

**构建配置：**
- Build Command: `npm run build`
- Output Directory: `build`
- Framework: `Vite`

#### 3. 测试部署

```bash
# 访问前端
https://your-app.vercel.app

# 测试后端API
curl https://your-backend.railway.app/api/health
```

### 成本估算

| 服务 | 免费额度 | 付费价格 |
|------|---------|---------|
| Vercel | 100GB带宽/月 | $20/月起 |
| Railway | $5免费额度 | 按使用量计费 |
| Supabase | 500MB数据库 | $25/月起 |
| **总计** | **完全免费（小项目）** | **$45/月起** |

---

## 🌟 方案B：全Vercel部署

### 架构
```
前端 → Vercel（静态站点）
后端 → Vercel Serverless Functions
数据库 → Vercel Postgres
```

### 优点
✅ **一站式管理**：所有配置在一个平台  
✅ **自动扩展**：Serverless自动处理流量峰值  
✅ **零配置CORS**：同域名，无跨域问题  
✅ **全球CDN**：API和前端都享受CDN加速  

### 缺点
❌ **需要重构后端**：Express需要转为Serverless函数  
❌ **函数限制**：
  - 执行时间限制（免费：10秒，付费：60秒）
  - 内存限制（最大3GB）
  - 请求体限制（4.5MB）
❌ **冷启动延迟**：首次请求可能较慢  
❌ **调试困难**：Serverless环境调试不便  
❌ **成本可能更高**：大量请求时费用增加  

### 适用场景
- ✅ 简单的CRUD应用
- ✅ 流量不大但突发性强
- ✅ 希望简化运维
- ❌ 不适合需要长时间运行的任务（如PDF生成）
- ❌ 不适合大文件处理

### 详细步骤

#### 1. 重构后端为Serverless函数

**创建 `api/` 文件夹结构：**
```
api/
├── auth/
│   ├── login.ts
│   └── register.ts
├── flight-logs/
│   ├── index.ts
│   └── [id].ts
├── drones.ts
└── users.ts
```

**示例函数：`api/flight-logs/index.ts`**
```typescript
import { VercelRequest, VercelResponse } from '@vercel/node';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export default async function handler(
  req: VercelRequest,
  res: VercelResponse
) {
  // CORS headers
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  try {
    if (req.method === 'GET') {
      const logs = await prisma.flightLog.findMany({
        take: 10,
        orderBy: { flightDate: 'desc' }
      });
      return res.status(200).json(logs);
    }
    
    if (req.method === 'POST') {
      const log = await prisma.flightLog.create({
        data: req.body
      });
      return res.status(201).json(log);
    }
    
    return res.status(405).json({ error: 'Method not allowed' });
  } catch (error) {
    console.error(error);
    return res.status(500).json({ error: 'Internal server error' });
  } finally {
    await prisma.$disconnect();
  }
}
```

#### 2. 配置 vercel.json

```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/$1"
    }
  ]
}
```

#### 3. 部署

```bash
# 安装Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署
vercel --prod
```

### 成本估算

| 服务 | 免费额度 | 付费价格 |
|------|---------|---------|
| Vercel Pro | 100GB带宽 | $20/月 |
| Vercel Postgres | 256MB | $0.3/GB |
| Serverless函数 | 100GB-小时 | $40/100万次调用 |
| **总计** | **适合小项目** | **$20-50/月** |

---

## 🚂 方案C：全Railway部署

### 架构
```
前端 + 后端 → Railway（Docker容器）
数据库 → Railway Postgres
```

### 优点
✅ **最简单**：一个平台，一次部署  
✅ **无需修改代码**：Express直接部署  
✅ **包含数据库**：自动创建PostgreSQL  
✅ **完整的服务器环境**：无Serverless限制  
✅ **易于调试**：可以查看完整日志  
✅ **成本可预测**：固定月费  

### 缺点
❌ **性能稍逊**：无全球CDN（可通过Cloudflare改善）  
❌ **需要同时部署前后端**：不能独立扩展  
❌ **免费额度有限**：$5/月免费额度  

### 适用场景
- ✅ 开发原型或小型项目
- ✅ 团队技术经验较少
- ✅ 预算有限
- ✅ 不需要极致性能

### 详细步骤

#### 1. 准备项目

修改 `package.json` 添加启动脚本：
```json
{
  "scripts": {
    "start": "npm run backend",
    "build": "npm run build && npx prisma generate"
  }
}
```

#### 2. 创建Railway项目

```bash
# 访问 https://railway.app
# 点击 "New Project"
# 选择 "Deploy from GitHub repo"
# 连接你的仓库
```

#### 3. 添加PostgreSQL数据库

```bash
# 在Railway项目中
# 点击 "New" → "Database" → "PostgreSQL"
# Railway会自动设置DATABASE_URL环境变量
```

#### 4. 配置环境变量

在Railway Dashboard添加：
```
JWT_SECRET=your-secret-key
NODE_ENV=production
PORT=3000
```

#### 5. 配置服务

**Settings → Deploy：**
- Build Command: `npm install && npx prisma generate && npm run build`
- Start Command: `npm run backend`

#### 6. 部署静态文件

Railway默认只运行后端。要同时提供前端：

**方法1：使用Express服务静态文件**

修改 `backend/src/index.ts`：
```typescript
import path from 'path';

// 服务静态文件
app.use(express.static(path.join(__dirname, '../../build')));

// API路由
app.use('/api/auth', authRoutes);
// ...其他路由

// 所有其他请求返回index.html（SPA路由）
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../../build/index.html'));
});
```

**方法2：分离部署**
- 前端部署到Vercel
- 后端部署到Railway

### 成本估算

| 服务 | 免费额度 | 付费价格 |
|------|---------|---------|
| Railway | $5/月 | 按使用量 |
| PostgreSQL | 包含在内 | 包含在内 |
| **总计** | **$5/月可用** | **$5-20/月** |

---

## 🤔 如何选择？

### 根据项目阶段选择

#### 原型/MVP阶段
**推荐：方案C（全Railway）**
- 快速上线
- 成本最低
- 易于修改

#### 产品上线
**推荐：方案A（Vercel + Railway）**
- 性能最佳
- 用户体验好
- 可扩展性强

#### 企业级应用
**推荐：方案A 或 自建服务器**
- 完全控制
- 最佳性能
- 可定制化

### 根据技术能力选择

#### 初学者
**推荐：方案C（全Railway）**
- 一键部署
- 简单配置
- 容易理解

#### 中级开发者
**推荐：方案A（Vercel + Railway）**
- 学习行业最佳实践
- 体验现代化部署流程
- 性能和成本平衡

#### 高级开发者
**推荐：方案B 或 Kubernetes**
- Serverless架构
- 微服务
- 自动扩展

### 根据预算选择

#### 预算 < $10/月
**推荐：方案C（全Railway）**
- $5/月即可运行
- 包含数据库
- 足够小型应用使用

#### 预算 $10-50/月
**推荐：方案A（Vercel + Railway）**
- 最佳性能价格比
- 适合中型应用
- 可根据流量调整

#### 预算 > $50/月
**推荐：方案A 或 AWS/GCP**
- 企业级服务
- 最佳性能
- 完全控制

---

## 📝 快速决策树

```
开始
 ↓
是否需要极致性能？
 ├─ 是 → 方案A（Vercel + Railway）
 └─ 否 ↓
       是否有预算限制？
        ├─ 是 → 方案C（全Railway）
        └─ 否 ↓
              是否愿意重构代码？
               ├─ 是 → 方案B（全Vercel）
               └─ 否 → 方案A（Vercel + Railway）
```

---

## 🎯 我的推荐

### 🥇 首选：方案A（Vercel + Railway）

**原因：**
1. **性能最佳**：前端使用Vercel全球CDN
2. **代码无需修改**：Express后端直接部署
3. **扩展性强**：前后端独立扩展
4. **生态成熟**：两个平台都有优秀的工具和文档

**适合：**
- 90%的项目
- 追求性能和用户体验
- 预期有一定流量
- 长期运营的产品

### 🥈 备选：方案C（全Railway）

**原因：**
1. **最简单**：一键部署，零配置
2. **成本低**：$5/月即可运行
3. **易于维护**：一个平台管理所有

**适合：**
- 原型和MVP
- 学习和实验项目
- 预算有限
- 快速验证想法

---

## 📚 相关文档

- [快速部署指南](./快速部署.md) - 5分钟快速部署
- [完整部署指南](./VERCEL_部署指南.md) - 详细步骤说明
- [部署检查清单](./部署检查清单.md) - 确保不遗漏任何步骤

---

**需要帮助？**
- 查看 [常见问题](./VERCEL_部署指南.md#-常见问题排查)
- 参考 [故障排查](./VERCEL_部署指南.md#-常见问题排查)

