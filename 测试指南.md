# 测试指南 - 本地存储和导出功能

## 测试前准备

1. **打开浏览器开发者工具**
   - Chrome/Edge: 按 `F12` 或 `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
   - 切换到 `Console` 标签页查看日志
   - 切换到 `Application` → `Local Storage` 查看存储的数据

2. **清除旧数据（可选）**
   - 如果需要从头开始测试，在 `Local Storage` 中删除以下键：
     - `flightLogs`
     - `pilots`
     - `uavs`
     - `dailyInspections`
     - `maintenanceRecords`

## 测试步骤

### 测试1: 飞行记录本地保存 ✈️

1. **添加飞行记录**
   - 打开应用首页
   - 确保选择了 "様式1" (飞行记录)
   - 填写飞行记录表单
   - 提交表单

2. **验证本地存储**
   - 打开开发者工具 → Application → Local Storage
   - 查看 `flightLogs` 键，应该能看到刚才添加的记录
   - 数据格式应该是JSON数组

3. **验证持久化**
   - 刷新页面 (`F5`)
   - 前往 "履歴" 标签页
   - 确认刚才添加的飞行记录依然显示

4. **预期控制台输出**
   ```
   ✅ 飞行记录已保存到localStorage
   ```

### 测试2: 日常点检记录本地保存 📋

1. **添加日常点检记录**
   - 在首页选择 "様式2" (日常点检记录)
   - 填写点检表单
   - 提交表单

2. **验证本地存储**
   - 开发者工具 → Application → Local Storage
   - 查看 `dailyInspections` 键
   - 应该能看到包含点检记录的JSON数组

3. **验证保存提示**
   - 即使显示 "401 Unauthorized" 错误
   - 应该仍然显示 "✅ 日常点検記録をローカルに保存しました！"
   - 数据依然保存在localStorage中

4. **预期控制台输出**
   ```
   ✅ 日常点検記録をローカルストレージに保存しました
   同期失敗、ローカル保存のみ: Error: 認証エラー
   ```

### 测试3: 点检整备记录本地保存 🔧

1. **添加点检整备记录**
   - 在首页选择 "様式3" (点检整备记录)
   - 填写整备表单
   - 提交表单

2. **验证本地存储**
   - 开发者工具 → Application → Local Storage
   - 查看 `maintenanceRecords` 键
   - 应该能看到整备记录

3. **预期控制台输出**
   ```
   ✅ 点検整備記録をローカルストレージに保存しました
   ```

### 测试4: CSV导出功能 📤

#### 4.1 导出飞行记录

1. **前往导出页面**
   - 点击底部 "その他" 标签
   - 点击 "エクスポート・設定"
   - 找到 "ローカルデータ出力" 部分

2. **无筛选导出**
   - 直接点击 "CSV出力" 按钮
   - 应该自动下载CSV文件
   - 文件名格式: `飛行記録_2025-11-13.csv`

3. **打开CSV文件**
   - 用Excel打开下载的CSV文件
   - 验证以下内容：
     - ✅ 日文正常显示（不乱码）
     - ✅ 包含所有飞行记录
     - ✅ 包含GPS坐标（如果有）
     - ✅ 特定飞行状态正确显示

4. **日期筛选导出**
   - 在 "开始日" 选择一个日期
   - 在 "终了日" 选择另一个日期
   - 点击 "CSV出力"
   - 验证导出的数据只包含该日期范围内的记录

#### 4.2 导出日常点检记录

1. **点击日常点检记录的 "CSV出力"**
2. **验证下载的文件**
   - 文件名: `日常点検記録_2025-11-13.csv`
   - 包含点检日期、机体、操作者等信息
   - 点检结果显示为 "合格" 或 "不合格"

#### 4.3 导出点检整备记录

1. **点击点检整备记录的 "CSV出力"**
2. **验证下载的文件**
   - 文件名: `点検整備記録_2025-11-13.csv`
   - 包含整备日期、机体、担当者等信息

### 测试5: JSON导出功能 💾

1. **导出JSON文件**
   - 在 "ローカルデータ出力" 部分
   - 点击 "JSON出力" 按钮
   - 下载JSON文件

2. **打开JSON文件**
   - 用文本编辑器打开
   - 验证JSON格式正确
   - 包含以下字段：
     - `exportDate`: 导出日期
     - `recordCount`: 记录数量
     - `dateRange`: 日期范围
     - `flights`: 飞行记录数组

3. **JSON结构示例**
   ```json
   {
     "exportDate": "2025-11-13T10:30:00.000Z",
     "recordCount": 5,
     "dateRange": {
       "from": null,
       "to": null
     },
     "flights": [
       {
         "id": "1699999999999",
         "date": "2025-11-13T10:30:00.000Z",
         "pilot": "山田太郎",
         ...
       }
     ]
   }
   ```

### 测试6: 边界情况测试 🧪

#### 6.1 没有数据时导出

1. **清空所有日常点检记录**
2. **尝试导出日常点检记录**
3. **预期行为**
   - 显示提示: "⚠️ エクスポートするデータがありません"
   - 不下载文件

#### 6.2 特殊字符测试

1. **添加包含特殊字符的飞行记录**
   - 备注中输入: `测试,包含"引号"和,逗号`
   - 地点输入: `东京都,渋谷区`

2. **导出CSV**
3. **验证CSV中的处理**
   - 包含逗号的字段应该被引号包围
   - 引号应该被转义为两个引号

#### 6.3 大量数据测试

1. **添加10+条飞行记录**
2. **导出CSV**
3. **验证**
   - 所有记录都包含在CSV中
   - 文件大小合理
   - Excel能正常打开

### 测试7: 离线功能测试 🔌

1. **断开网络连接**
   - 在开发者工具中: Network → Offline
   - 或者关闭WiFi

2. **添加飞行记录**
   - 应该能正常添加
   - 显示保存成功

3. **验证localStorage**
   - 数据应该保存在localStorage中
   - 控制台可能显示同步失败，但这是正常的

4. **导出数据**
   - 离线状态下也能导出
   - CSV和JSON导出都应该正常工作

5. **恢复网络连接**
   - 重新连接网络
   - 数据应该自动同步到服务器（如果实现了同步功能）

## 常见问题排查

### 问题1: CSV文件乱码

**检查步骤：**
1. 用记事本打开CSV文件
2. 查看文件开头是否有BOM标记（不可见字符）
3. 尝试用Excel的 "数据" → "从文本导入" 功能

**预期：**
- 文件应该使用BOM标记的UTF-8编码
- Excel应该自动识别并正确显示

### 问题2: 数据没有保存

**检查步骤：**
1. 打开开发者工具 → Console
2. 查看是否有JavaScript错误
3. 检查 Local Storage 是否被禁用
4. 确认不是在隐私模式下

**预期控制台输出：**
```
✅ 飞行记录已保存到localStorage
```

### 问题3: 导出按钮没反应

**检查步骤：**
1. 查看控制台是否有错误
2. 确认浏览器没有阻止下载
3. 检查是否有数据可以导出

**预期行为：**
- 点击按钮后立即下载文件
- 显示成功提示

### 问题4: 401认证错误

**说明：**
- 这是正常现象（服务器未配置或未登录）
- 数据依然会保存到localStorage
- 不影响本地存储和导出功能

**验证：**
- 即使有401错误，localStorage中应该有数据
- 导出功能应该正常工作

## 性能测试

### 存储容量测试

1. **添加大量数据**
   - 持续添加飞行记录，直到约100条
   - 查看localStorage的大小

2. **检查localStorage容量**
   ```javascript
   // 在控制台运行
   let total = 0;
   for(let key in localStorage) {
     if(localStorage.hasOwnProperty(key)) {
       total += localStorage[key].length + key.length;
     }
   }
   console.log(`Total size: ${(total / 1024).toFixed(2)} KB`);
   ```

3. **预期：**
   - 100条记录应该在1MB以内
   - localStorage限制通常是5-10MB

### 导出性能测试

1. **导出大量数据**
   - 导出100条记录的CSV
   - 记录导出时间

2. **预期：**
   - 100条记录应该在1秒内完成
   - 浏览器不应该卡顿

## 测试报告模板

```
测试日期: 2025-11-13
测试人员: [姓名]
浏览器: Chrome 119.0 / Safari 17.0 / Firefox 120.0

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 飞行记录本地保存 | ✅ / ❌ | |
| 日常点检本地保存 | ✅ / ❌ | |
| 点检整备本地保存 | ✅ / ❌ | |
| CSV导出飞行记录 | ✅ / ❌ | |
| CSV导出日常点检 | ✅ / ❌ | |
| CSV导出点检整备 | ✅ / ❌ | |
| JSON导出 | ✅ / ❌ | |
| 日期筛选导出 | ✅ / ❌ | |
| 特殊字符处理 | ✅ / ❌ | |
| 离线功能 | ✅ / ❌ | |
| Excel兼容性 | ✅ / ❌ | |
| 刷新后数据保留 | ✅ / ❌ | |

发现的问题:
1. 
2. 

建议改进:
1. 
2. 
```

## 自动化测试脚本

如果需要快速测试，可以在浏览器控制台运行以下脚本：

```javascript
// 测试localStorage保存
console.log('=== 测试localStorage保存 ===');
console.log('Flights:', localStorage.getItem('flightLogs') ? 'OK' : 'EMPTY');
console.log('Pilots:', localStorage.getItem('pilots') ? 'OK' : 'EMPTY');
console.log('UAVs:', localStorage.getItem('uavs') ? 'OK' : 'EMPTY');
console.log('Daily Inspections:', localStorage.getItem('dailyInspections') ? 'OK' : 'EMPTY');
console.log('Maintenance Records:', localStorage.getItem('maintenanceRecords') ? 'OK' : 'EMPTY');

// 显示数据数量
try {
  const flights = JSON.parse(localStorage.getItem('flightLogs') || '[]');
  const inspections = JSON.parse(localStorage.getItem('dailyInspections') || '[]');
  const maintenance = JSON.parse(localStorage.getItem('maintenanceRecords') || '[]');
  
  console.log('=== 数据统计 ===');
  console.log(`飞行记录: ${flights.length} 条`);
  console.log(`日常点检: ${inspections.length} 条`);
  console.log(`点检整备: ${maintenance.length} 条`);
} catch (e) {
  console.error('数据解析失败:', e);
}
```



