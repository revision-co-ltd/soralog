# è´¦å·ç™»å½•å’Œæ•°æ®éš”ç¦»æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

åº”ç”¨ç°åœ¨æ”¯æŒå®Œæ•´çš„è´¦å·ç™»å½•ç³»ç»Ÿï¼Œæä¾›ï¼š

- âœ… **é‚®ç®±/å¯†ç æ³¨å†Œç™»å½•**
- âœ… **ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»** - é€šè¿‡ Row Level Security (RLS)
- âœ… **å¤šè®¾å¤‡æ•°æ®åŒæ­¥** - åŒä¸€è´¦å·åœ¨ä¸åŒè®¾å¤‡è‡ªåŠ¨åŒæ­¥
- âœ… **ç¦»çº¿ä¼˜å…ˆ** - æœªç™»å½•ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨
- âœ… **ä¼˜é›…é™çº§** - æœªé…ç½® Supabase æ—¶ä»å¯ç¦»çº¿å·¥ä½œ

---

## ğŸ” æ•°æ®éš”ç¦»åŸç†

### Row Level Security (RLS)

Supabase çš„æ•°æ®åº“è¡¨éƒ½å¯ç”¨äº†è¡Œçº§å®‰å…¨ç­–ç•¥ï¼š

```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é£è¡Œè®°å½•
CREATE POLICY "Users can view own flight logs"
  ON flight_logs FOR SELECT
  USING (auth.uid() = user_id);

-- ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®°å½•
CREATE POLICY "Users can insert own flight logs"
  ON flight_logs FOR INSERT
  WITH CHECK (auth.uid() = user_id);
```

**æ•ˆæœ**:
- ç”¨æˆ·Açœ‹ä¸åˆ°ç”¨æˆ·Bçš„æ•°æ®
- å³ä½¿æœ‰ API å¯†é’¥ï¼Œä¹Ÿæ— æ³•è®¿é—®ä»–äººæ•°æ®
- æ•°æ®åº“å±‚é¢å¼ºåˆ¶éš”ç¦»ï¼Œå®‰å…¨å¯é 

---

## ğŸ“‹ ä½¿ç”¨æµç¨‹

### åœºæ™¯ 1ï¼šæ–°ç”¨æˆ·æ³¨å†Œ

1. **æ‰“å¼€åº”ç”¨**
   - å³ä¸Šè§’ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†

2. **åˆ‡æ¢åˆ°æ³¨å†Œæ ‡ç­¾**
   - å¡«å†™é‚®ç®±å’Œå¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰
   - ç¡®è®¤å¯†ç 
   - ç‚¹å‡»"æ³¨å†Œ"

3. **æ³¨å†ŒæˆåŠŸ**
   - è‡ªåŠ¨ç™»å½•
   - é¡µé¢æ˜¾ç¤ºç”¨æˆ·å¤´åƒï¼ˆé‚®ç®±é¦–å­—æ¯ï¼‰
   - å¼€å§‹ä½¿ç”¨åº”ç”¨

4. **æ·»åŠ æ•°æ®**
   - æ‰€æœ‰æ•°æ®è‡ªåŠ¨å…³è”åˆ°ä½ çš„è´¦å·
   - `user_id` å­—æ®µè‡ªåŠ¨å¡«å……

### åœºæ™¯ 2ï¼šè€ç”¨æˆ·ç™»å½•

1. **æ‰“å¼€åº”ç”¨**
   - ç‚¹å‡»å³ä¸Šè§’"ç™»å½•"

2. **è¾“å…¥å‡­è¯**
   - è¾“å…¥æ³¨å†Œçš„é‚®ç®±å’Œå¯†ç 
   - ç‚¹å‡»"ç™»å½•"

3. **è‡ªåŠ¨åŒæ­¥**
   - ä»äº‘ç«¯åŠ è½½ä½ çš„å†å²æ•°æ®
   - æœ¬åœ°æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰ä¿æŒä¸å˜
   - æ–°æ•°æ®ä¼šåŒæ­¥åˆ°äº‘ç«¯

### åœºæ™¯ 3ï¼šå¤šè®¾å¤‡ä½¿ç”¨

**è®¾å¤‡Aï¼ˆç”µè„‘ï¼‰**:
1. ç™»å½•è´¦å· â†’ æ·»åŠ é£è¡Œè®°å½•
2. æ•°æ®ä¿å­˜åˆ°æœ¬åœ° + äº‘ç«¯

**è®¾å¤‡Bï¼ˆå¹³æ¿ï¼‰**:
1. ä½¿ç”¨åŒä¸€è´¦å·ç™»å½•
2. è‡ªåŠ¨ä¸‹è½½è®¾å¤‡Açš„æ•°æ®
3. æ·»åŠ æ–°è®°å½• â†’ åŒæ­¥åˆ°äº‘ç«¯

**è®¾å¤‡Aï¼ˆå†æ¬¡æ‰“å¼€ï¼‰**:
- è‡ªåŠ¨åŒæ­¥è®¾å¤‡Bçš„æ–°æ•°æ®
- å®ç°åŒå‘åŒæ­¥

### åœºæ™¯ 4ï¼šç¦»çº¿ä½¿ç”¨ï¼ˆæœªç™»å½•ï¼‰

1. **ç›´æ¥ä½¿ç”¨åº”ç”¨**
   - ä¸ç™»å½•ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨
   - æ•°æ®ä¿å­˜åœ¨æœ¬åœ° IndexedDB
   - åŠŸèƒ½å®Œå…¨æ­£å¸¸

2. **åç»­ç™»å½•**
   - æœ¬åœ°æ•°æ®å¯é€‰æ‹©ä¸Šä¼ åˆ°äº‘ç«¯
   - æˆ–ç»§ç»­ç¦»çº¿ä½¿ç”¨

---

## ğŸ”‘ è®¤è¯çŠ¶æ€ç®¡ç†

### ç”¨æˆ·çŠ¶æ€

```typescript
// ä½¿ç”¨ React Context å…¨å±€ç®¡ç†
const { user, isAuthenticated } = useAuth();

// user å¯¹è±¡åŒ…å«
{
  id: 'uuid',              // Supabase ç”¨æˆ· ID
  email: 'user@email.com', // ç”¨æˆ·é‚®ç®±
  created_at: '...'        // æ³¨å†Œæ—¶é—´
}
```

### ç™»å½•çŠ¶æ€æ£€æµ‹

åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹ï¼š

```
1. æ£€æŸ¥ Supabase session
2. å¦‚æœæœ‰æœ‰æ•ˆ session â†’ è‡ªåŠ¨ç™»å½•
3. å¦‚æœæ²¡æœ‰ â†’ æ˜¾ç¤º"ç™»å½•"æŒ‰é’®
```

### ç”¨æˆ·èœå•

**å·²ç™»å½•æ—¶æ˜¾ç¤ºï¼š**
- ç”¨æˆ·å¤´åƒï¼ˆé‚®ç®±é¦–å­—æ¯ï¼‰
- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆåœ¨çº¿/ç¦»çº¿/åŒæ­¥ä¸­ï¼‰
- ä¸‹æ‹‰èœå•ï¼š
  - æˆ‘çš„è´¦å·ï¼ˆé‚®ç®±ï¼‰
  - è®¾ç½®ï¼ˆå³å°†æ¨å‡ºï¼‰
  - æ•°æ®ç®¡ç†ï¼ˆå³å°†æ¨å‡ºï¼‰
  - **ç™»å‡º**

**æœªç™»å½•æ—¶æ˜¾ç¤ºï¼š**
- "ç™»å½•"æŒ‰é’®

---

## ğŸ”„ æ•°æ®åŒæ­¥é€»è¾‘

### å·²ç™»å½• + åœ¨çº¿

```
ç”¨æˆ·æ“ä½œï¼ˆæ·»åŠ è®°å½•ï¼‰
    â†“
1. ä¿å­˜åˆ° IndexedDBï¼ˆç«‹å³ï¼‰
2. è‡ªåŠ¨æ³¨å…¥ user_id
3. åå°åŒæ­¥åˆ° Supabase
4. RLS æ£€æŸ¥ï¼šuser_id æ˜¯å¦åŒ¹é…
5. åŒæ­¥æˆåŠŸ âœ…
```

### å·²ç™»å½• + ç¦»çº¿

```
ç”¨æˆ·æ“ä½œ
    â†“
1. ä¿å­˜åˆ° IndexedDB
2. æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ï¼ˆå¸¦ user_idï¼‰
3. UI ç«‹å³æ›´æ–°
4. ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥
```

### æœªç™»å½•

```
ç”¨æˆ·æ“ä½œ
    â†“
1. ä¿å­˜åˆ° IndexedDB
2. ä¸å°è¯•äº‘ç«¯åŒæ­¥
3. ä»…æœ¬åœ°å­˜å‚¨
4. ç™»å½•åå¯é€‰æ‹©ä¸Šä¼ 
```

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. å¯†ç å®‰å…¨

- âœ… Supabase è‡ªåŠ¨åŠ å¯†å¯†ç ï¼ˆbcryptï¼‰
- âœ… ä¸å­˜å‚¨æ˜æ–‡å¯†ç 
- âœ… å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦

### 2. Session ç®¡ç†

- âœ… JWT Token è‡ªåŠ¨åˆ·æ–°
- âœ… Token è¿‡æœŸè‡ªåŠ¨ç™»å‡º
- âœ… å®‰å…¨çš„ HTTP-only cookiesï¼ˆå¯é€‰ï¼‰

### 3. æ•°æ®éš”ç¦»

- âœ… è¡Œçº§å®‰å…¨ (RLS) å¼ºåˆ¶éš”ç¦»
- âœ… ç”¨æˆ·æ— æ³•æŸ¥è¯¢ä»–äººæ•°æ®
- âœ… API å¯†é’¥å…¬å¼€ä¹Ÿå®‰å…¨ï¼ˆå— RLS ä¿æŠ¤ï¼‰

### 4. SQL æ³¨å…¥é˜²æŠ¤

- âœ… Supabase è‡ªåŠ¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… æ—  SQL æ³¨å…¥é£é™©

---

## ğŸ“Š æ•°æ®è¡¨ç»“æ„

### æ‰€æœ‰è¡¨éƒ½åŒ…å« user_id

```sql
-- flight_logs è¡¨
CREATE TABLE flight_logs (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,  -- ğŸ‘ˆ å…³è”åˆ°è®¤è¯ç”¨æˆ·
  date DATE,
  pilot TEXT,
  ...
);

-- pilots è¡¨
CREATE TABLE pilots (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,  -- ğŸ‘ˆ å…³è”åˆ°è®¤è¯ç”¨æˆ·
  name TEXT,
  ...
);

-- uavs è¡¨
CREATE TABLE uavs (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,  -- ğŸ‘ˆ å…³è”åˆ°è®¤è¯ç”¨æˆ·
  model TEXT,
  ...
);
```

### user_id è‡ªåŠ¨æ³¨å…¥

```typescript
// åœ¨ supabase-sync.service.ts ä¸­
convertToSupabaseFormat(data, type) {
  return {
    user_id: this.currentUserId,  // ğŸ‘ˆ è‡ªåŠ¨æ³¨å…¥å½“å‰ç”¨æˆ· ID
    ...data
  };
}
```

ç”¨æˆ·æ— éœ€å…³å¿ƒ `user_id`ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯• 1ï¼šæ³¨å†Œæ–°ç”¨æˆ·

```
1. æ‰“å¼€åº”ç”¨ â†’ ç‚¹å‡»"ç™»å½•"
2. åˆ‡æ¢åˆ°"æ³¨å†Œ"æ ‡ç­¾
3. è¾“å…¥ï¼š
   - é‚®ç®±: test1@example.com
   - å¯†ç : password123
4. ç‚¹å‡»"æ³¨å†Œ"
5. âœ… éªŒè¯ï¼šå³ä¸Šè§’æ˜¾ç¤ºå¤´åƒï¼ˆTï¼‰
6. âœ… éªŒè¯ï¼šåŒæ­¥çŠ¶æ€ä¸º"åœ¨çº¿"
```

### æµ‹è¯• 2ï¼šæ•°æ®éš”ç¦»

```
1. ç”¨æˆ·Aç™»å½• â†’ æ·»åŠ é£è¡Œè®°å½•
2. ç™»å‡º
3. ç”¨æˆ·Bç™»å½• â†’ æŸ¥çœ‹é£è¡Œè®°å½•
4. âœ… éªŒè¯ï¼šç”¨æˆ·Bçœ‹ä¸åˆ°ç”¨æˆ·Açš„æ•°æ®
```

### æµ‹è¯• 3ï¼šå¤šè®¾å¤‡åŒæ­¥

```
è®¾å¤‡1:
1. ç™»å½• test1@example.com
2. æ·»åŠ è®°å½• "é£è¡ŒA"

è®¾å¤‡2:
1. ç™»å½• test1@example.com
2. âœ… éªŒè¯ï¼šè‡ªåŠ¨åŠ è½½"é£è¡ŒA"
3. æ·»åŠ è®°å½• "é£è¡ŒB"

è®¾å¤‡1ï¼ˆåˆ·æ–°ï¼‰:
4. âœ… éªŒè¯ï¼šè‡ªåŠ¨åŠ è½½"é£è¡ŒB"
```

### æµ‹è¯• 4ï¼šç¦»çº¿ä½¿ç”¨

```
1. ä¸ç™»å½•ï¼Œç›´æ¥ä½¿ç”¨
2. æ·»åŠ é£è¡Œè®°å½•
3. âœ… éªŒè¯ï¼šæ•°æ®ä¿å­˜åœ¨ IndexedDB
4. åˆ·æ–°é¡µé¢
5. âœ… éªŒè¯ï¼šæ•°æ®ä»ç„¶å­˜åœ¨
6. ç™»å½•
7. âœ… éªŒè¯ï¼šæœ¬åœ°æ•°æ®å¯ä¸Šä¼ ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. AuthContext (å…¨å±€è®¤è¯çŠ¶æ€)

```typescript
// src/contexts/AuthContext.tsx
export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  
  // åˆå§‹åŒ–æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    checkUser();
  }, []);
  
  return (
    <AuthContext.Provider value={{ user, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}
```

### 2. AuthModal (ç™»å½•/æ³¨å†ŒUI)

```typescript
// src/components/AuthModal.tsx
export function AuthModal({ onSuccess }) {
  const [mode, setMode] = useState('login');
  
  const handleSubmit = async () => {
    if (mode === 'login') {
      await supabaseAuth.signInWithEmail(email, password);
    } else {
      await supabaseAuth.signUpWithEmail(email, password);
    }
  };
}
```

### 3. UserMenu (ç”¨æˆ·èœå•)

```typescript
// src/components/UserMenu.tsx
export function UserMenu({ syncStatus }) {
  const { user, signOut } = useAuth();
  
  return (
    <DropdownMenu>
      <Avatar>{user.email[0]}</Avatar>
      <MenuItem onClick={signOut}>ç™»å‡º</MenuItem>
    </DropdownMenu>
  );
}
```

### 4. åŒæ­¥æœåŠ¡é›†æˆ

```typescript
// supabase-sync.service.ts ä¿®æ”¹
async init() {
  // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
  const user = await supabaseAuth.getCurrentUser();
  if (!user) {
    console.log('æœªç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼');
    return;
  }
  
  this.currentUserId = user.id;
  // ç»§ç»­åˆå§‹åŒ–åŒæ­¥...
}
```

---

## ğŸ“ Supabase é…ç½®

### å¯ç”¨é‚®ç®±è®¤è¯

åœ¨ Supabase æ§åˆ¶å°ï¼š

1. **Authentication** â†’ **Providers**
2. ç¡®ä¿ **Email** å·²å¯ç”¨
3. é…ç½®é€‰é¡¹ï¼š
   - **Confirm email**: å»ºè®®å…³é—­ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
   - **Secure email change**: å¼€å¯ï¼ˆå®‰å…¨ï¼‰

### RLS ç­–ç•¥å·²è‡ªåŠ¨åˆ›å»º

æ‰§è¡Œ `supabase-migration.sql` æ—¶å·²åˆ›å»ºï¼š

```sql
-- âœ… å·²åŒ…å«åœ¨è¿ç§»è„šæœ¬ä¸­
ALTER TABLE flight_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own flight logs"
  ON flight_logs FOR SELECT
  USING (auth.uid() = user_id);
  
-- ... å…¶ä»–ç­–ç•¥
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ä¸ªäººç”¨æˆ·

**æ¨èæµç¨‹ï¼š**
1. æ³¨å†Œè´¦å·
2. åœ¨ä¸»è®¾å¤‡ï¼ˆç”µè„‘ï¼‰ä¸Šä½¿ç”¨
3. éœ€è¦æ—¶åœ¨ç§»åŠ¨è®¾å¤‡ç™»å½•åŒä¸€è´¦å·
4. æ•°æ®è‡ªåŠ¨åŒæ­¥

### å›¢é˜Ÿä½¿ç”¨ï¼ˆæœªæ¥ï¼‰

**å½“å‰é™åˆ¶ï¼š**
- æ¯ä¸ªç”¨æˆ·çœ‹åˆ°è‡ªå·±çš„æ•°æ®
- æ²¡æœ‰å…±äº«ç»„ç»‡åŠŸèƒ½

**æœªæ¥æ‰©å±•ï¼š**
- æ·»åŠ  `organization_id` å­—æ®µ
- å®ç°å›¢é˜Ÿå…±äº«æ•°æ®
- è§’è‰²å’Œæƒé™ç®¡ç†

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¿˜è®°å¯†ç æ€ä¹ˆåŠï¼Ÿ

**å½“å‰ï¼š** æ— å¯†ç é‡ç½®åŠŸèƒ½

**ä¸´æ—¶æ–¹æ¡ˆï¼š**
1. æ³¨å†Œæ–°è´¦å·
2. æˆ–åœ¨ Supabase æ§åˆ¶å°æ‰‹åŠ¨é‡ç½®

**æœªæ¥ï¼š** æ·»åŠ å¯†ç é‡ç½®é‚®ä»¶

### Q2: å¯ä»¥ä¿®æ”¹é‚®ç®±å—ï¼Ÿ

**å½“å‰ï¼š** ä¸æ”¯æŒ

**æœªæ¥ï¼š** æ·»åŠ è´¦å·è®¾ç½®é¡µé¢

### Q3: å¦‚ä½•åˆ é™¤è´¦å·ï¼Ÿ

åœ¨ Supabase æ§åˆ¶å°ï¼š
1. Authentication â†’ Users
2. æ‰¾åˆ°ç”¨æˆ· â†’ Delete

**æ³¨æ„ï¼š** åˆ é™¤ç”¨æˆ·ä¼šçº§è”åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆON DELETE CASCADEï¼‰

### Q4: å¤šä¸ªè®¾å¤‡åŒæ—¶ç¼–è¾‘ä¼šå†²çªå—ï¼Ÿ

**å½“å‰ç­–ç•¥ï¼š** Last Write Winsï¼ˆæœ€åå†™å…¥ä¼˜å…ˆï¼‰

**åœºæ™¯ï¼š**
- è®¾å¤‡Aä¿®æ”¹è®°å½• â†’ åŒæ­¥
- è®¾å¤‡BåŒæ—¶ä¿®æ”¹åŒä¸€è®°å½• â†’ åŒæ­¥
- ç»“æœï¼šååŒæ­¥çš„è¦†ç›–å…ˆåŒæ­¥çš„

**æœªæ¥æ”¹è¿›ï¼š** æ·»åŠ å†²çªæ£€æµ‹å’Œåˆå¹¶UI

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡®è®¤æ–‡ä»¶å·²åˆ›å»º

```bash
âœ… src/components/AuthModal.tsx       # ç™»å½•/æ³¨å†ŒUI
âœ… src/contexts/AuthContext.tsx        # è®¤è¯çŠ¶æ€ç®¡ç†
âœ… src/components/UserMenu.tsx         # ç”¨æˆ·èœå•
âœ… src/main.tsx                        # å·²æ·»åŠ  AuthProvider
âœ… src/App.tsx                         # å·²é›†æˆ UserMenu
âœ… src/services/supabase-sync.service.ts # å·²ç§»é™¤åŒ¿åç™»å½•
```

### 2. å¯åŠ¨åº”ç”¨

```bash
npm run dev
```

### 3. é…ç½® Supabaseï¼ˆå¦‚è¿˜æœªé…ç½®ï¼‰

```bash
# åˆ›å»º .env æ–‡ä»¶
VITE_SUPABASE_URL=https://ä½ çš„é¡¹ç›®.supabase.co
VITE_SUPABASE_ANON_KEY=ä½ çš„å¯†é’¥

# é‡å¯åº”ç”¨
```

### 4. æµ‹è¯•ç™»å½•

1. æ‰“å¼€åº”ç”¨
2. å³ä¸Šè§’ç‚¹å‡»"ç™»å½•"
3. æ³¨å†Œæ–°è´¦å·
4. âœ… æˆåŠŸï¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Supabase è®¾ç½®**: `SUPABASE-SETUP.md`
- **å¿«é€Ÿå¼€å§‹**: `QUICK-START-SUPABASE.md`
- **æ•°æ®åº“è¿ç§»**: `supabase-migration.sql`

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-15  
**ç‰ˆæœ¬**: 2.1.0 (with Authentication)  
**çŠ¶æ€**: âœ… å®Œæˆ - å¯ä»¥å¼€å§‹ä½¿ç”¨ï¼

