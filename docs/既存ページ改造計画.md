# 既存ページ改造計画 - 様式対応への段階的移行

**作成日**: 2025年11月13日  
**目的**: 現在のプロトタイプUIを国交省様式1〜3に完全対応させる

---

## 📊 現状分析

### 既存コンポーネントの評価

| コンポーネント | 現在の機能 | 様式要件との差異 | 対応方針 |
|--------------|-----------|----------------|---------|
| `FlightLogForm.tsx` | 簡易版飛行記録 | 様式1の20項目中10項目のみ | ✏️ 拡張 |
| `UAVManagement.tsx` | 機体管理 | 登録記号・メーカー等は有 | ✅ ほぼOK |
| `App.tsx` | メインUI・ナビゲーション | 様式別タブなし | ✏️ 再構成 |
| `LocationInput.tsx` | 場所入力・地図選択 | ✅ 完成度高い | ✅ 使用可 |
| `DatePicker.tsx` | 日付選択 | ✅ 完成度高い | ✅ 使用可 |
| `MapPicker.tsx` | 地図選択 | ✅ 完成度高い | ✅ 使用可 |

### 不足しているコンポーネント

- ❌ `DailyInspectionForm.tsx` - 日常点検記録（様式2）
- ❌ `MaintenanceRecordForm.tsx` - 点検整備記録（様式3）
- ❌ `FlightLogList.tsx` - 飛行記録一覧（高度な検索・フィルタ）
- ❌ `ExportPanel.tsx` - CSV/Excel/PDF エクスポート画面
- ❌ API 接続ロジック - 現在は localStorage のみ

---

## 🎯 改造戦略

### Phase A: データ構造の移行（バックエンド連携準備）

**目的**: localStorage から API 接続への移行準備

#### A-1: 型定義の作成（1日）

現在の `interface` を Prisma スキーマに合わせて拡張：

```typescript
// src/types/index.ts を新規作成
export interface Organization {
  id: string;
  name: string;
  code: string;
}

export interface User {
  id: string;
  organizationId: string;
  email: string;
  name: string;
  licenseNumber?: string;
  role: 'operator' | 'admin' | 'system_admin';
}

export interface Drone {
  id: string;
  organizationId: string;
  registrationMark: string;  // 登録記号（必須）
  name: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  certificationNumber?: string;  // 機体認証番号
  totalFlightHours: number;
  status: 'active' | 'maintenance' | 'retired';
}

export interface Location {
  id: string;
  organizationId: string;
  name: string;
  address?: string;
  latitude?: number;
  longitude?: number;
  isDid: boolean;  // 人口集中地区フラグ
  requiresPermit: boolean;
}

// 様式1: 飛行記録（拡張版）
export interface FlightLog {
  id: string;
  organizationId: string;
  droneId: string;
  operatorId: string;
  flightDate: Date;
  purpose: string;
  outline?: string;  // 飛行経路概要
  isTokuteiFlight: boolean;  // 特定飛行フラグ
  flightPlanNotified?: boolean;  // 飛行計画の通報有無
  
  takeoffLocationId?: string;
  takeoffTime: string;  // HH:mm
  landingLocationId?: string;
  landingTime: string;  // HH:mm
  flightTimeMinutes?: number;  // 自動計算
  totalTimeSinceManufactured?: number;  // 製造後の総飛行時間
  
  safetyImpactNote?: string;  // 飛行の安全に影響のあった事項
  faultDate?: Date;  // 不具合発生日
  faultDetail?: string;
  fixDate?: Date;  // 処置実施日
  fixDetail?: string;
  confirmerId?: string;  // 確認者
  
  retentionUntil: Date;  // 保存期限（自動計算: flightDate + 3年）
  createdAt: Date;
  updatedAt: Date;
}

// 様式2: 日常点検記録（新規）
export interface DailyInspection {
  id: string;
  organizationId: string;
  droneId: string;
  inspectionType: 'pre-flight' | 'post-flight';
  executionDate: Date;
  executionPlaceId?: string;
  executorId: string;
  
  // 点検項目（各項目: result + note）
  resultAirframe?: '正常' | '異常' | '未選択';
  noteAirframe?: string;
  resultPropeller?: '正常' | '異常' | '未選択';
  notePropeller?: string;
  resultFrame?: '正常' | '異常' | '未選択';
  noteFrame?: string;
  resultCommunication?: '正常' | '異常' | '未選択';
  noteCommunication?: string;
  resultPropulsion?: '正常' | '異常' | '未選択';
  notePropulsion?: string;
  resultPower?: '正常' | '異常' | '未選択';
  notePower?: string;
  resultControl?: '正常' | '異常' | '未選択';
  noteControl?: string;
  resultController?: '正常' | '異常' | '未選択';
  noteController?: string;
  resultBattery?: '正常' | '異常' | '未選択';
  noteBattery?: string;
  resultRemoteId?: '正常' | '異常' | '未選択';
  noteRemoteId?: string;
  resultLights?: '正常' | '異常' | '未選択';
  noteLights?: string;
  resultCamera?: '正常' | '異常' | '未選択';
  noteCamera?: string;
  
  specialNote?: string;  // 特記事項
  overallResult?: '正常' | '異常';  // 自動判定
  
  retentionUntil: Date;
  createdAt: Date;
  updatedAt: Date;
}

// 様式3: 点検整備記録（新規）
export interface MaintenanceRecord {
  id: string;
  organizationId: string;
  droneId: string;
  executionDate: Date;
  totalFlightTimeAtMoment?: number;  // その時点の総飛行時間
  workContent: string;  // 点検・修理・改造及び整備の内容
  reason?: string;  // 実施理由
  executionPlaceId?: string;
  executorId: string;
  nextDueNote?: string;  // その他特記事項
  
  retentionUntil: Date;
  createdAt: Date;
  updatedAt: Date;
}
```

**ファイル**: `src/types/index.ts`

#### A-2: API サービス層の作成（2日）

```typescript
// src/services/api.service.ts
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3000/api';

// 認証トークンの管理
let authToken: string | null = localStorage.getItem('auth_token');

export const setAuthToken = (token: string) => {
  authToken = token;
  localStorage.setItem('auth_token', token);
};

export const clearAuthToken = () => {
  authToken = null;
  localStorage.removeItem('auth_token');
};

const fetchWithAuth = async (url: string, options: RequestInit = {}) => {
  const headers = {
    'Content-Type': 'application/json',
    ...(authToken && { Authorization: `Bearer ${authToken}` }),
    ...options.headers,
  };

  const response = await fetch(`${API_BASE_URL}${url}`, {
    ...options,
    headers,
  });

  if (response.status === 401) {
    clearAuthToken();
    throw new Error('認証エラー: ログインしてください');
  }

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || 'APIエラーが発生しました');
  }

  return response.json();
};

// 飛行記録 API
export const flightLogApi = {
  getAll: (params?: { droneId?: string; from?: string; to?: string }) =>
    fetchWithAuth(`/flight-logs?${new URLSearchParams(params as any)}`),
  
  getById: (id: string) =>
    fetchWithAuth(`/flight-logs/${id}`),
  
  create: (data: Omit<FlightLog, 'id' | 'createdAt' | 'updatedAt'>) =>
    fetchWithAuth('/flight-logs', { method: 'POST', body: JSON.stringify(data) }),
  
  update: (id: string, data: Partial<FlightLog>) =>
    fetchWithAuth(`/flight-logs/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
  
  delete: (id: string) =>
    fetchWithAuth(`/flight-logs/${id}`, { method: 'DELETE' }),
  
  exportCsv: (params?: any) =>
    fetch(`${API_BASE_URL}/flight-logs/export/csv?${new URLSearchParams(params)}`, {
      headers: { Authorization: `Bearer ${authToken}` },
    }).then(res => res.blob()),
};

// 日常点検 API
export const dailyInspectionApi = {
  getAll: (params?: any) => fetchWithAuth(`/daily-inspections?${new URLSearchParams(params)}`),
  getById: (id: string) => fetchWithAuth(`/daily-inspections/${id}`),
  create: (data: any) => fetchWithAuth('/daily-inspections', { method: 'POST', body: JSON.stringify(data) }),
  update: (id: string, data: any) => fetchWithAuth(`/daily-inspections/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
  delete: (id: string) => fetchWithAuth(`/daily-inspections/${id}`, { method: 'DELETE' }),
};

// 点検整備 API
export const maintenanceRecordApi = {
  getAll: (params?: any) => fetchWithAuth(`/maintenance-records?${new URLSearchParams(params)}`),
  getById: (id: string) => fetchWithAuth(`/maintenance-records/${id}`),
  create: (data: any) => fetchWithAuth('/maintenance-records', { method: 'POST', body: JSON.stringify(data) }),
  update: (id: string, data: any) => fetchWithAuth(`/maintenance-records/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
  delete: (id: string) => fetchWithAuth(`/maintenance-records/${id}`, { method: 'DELETE' }),
};

// 機体 API
export const droneApi = {
  getAll: () => fetchWithAuth('/drones'),
  getById: (id: string) => fetchWithAuth(`/drones/${id}`),
  create: (data: any) => fetchWithAuth('/drones', { method: 'POST', body: JSON.stringify(data) }),
  update: (id: string, data: any) => fetchWithAuth(`/drones/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
  delete: (id: string) => fetchWithAuth(`/drones/${id}`, { method: 'DELETE' }),
};

// 場所 API
export const locationApi = {
  getAll: () => fetchWithAuth('/locations'),
  getById: (id: string) => fetchWithAuth(`/locations/${id}`),
  create: (data: any) => fetchWithAuth('/locations', { method: 'POST', body: JSON.stringify(data) }),
  update: (id: string, data: any) => fetchWithAuth(`/locations/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
  delete: (id: string) => fetchWithAuth(`/locations/${id}`, { method: 'DELETE' }),
};

// 認証 API
export const authApi = {
  login: (email: string, password: string) =>
    fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    }).then(res => res.json()),
  
  register: (data: { email: string; password: string; name: string; organizationId: string }) =>
    fetch(`${API_BASE_URL}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    }).then(res => res.json()),
  
  me: () => fetchWithAuth('/auth/me'),
};
```

**ファイル**: `src/services/api.service.ts`

---

### Phase B: FlightLogForm の拡張（様式1完全対応）

**期間**: 2日

#### B-1: 現在のフィールド vs 様式1の必須フィールド

| 項目 | 現在 | 様式1要件 | 対応 |
|-----|------|----------|------|
| 飛行年月日 | ✅ | ✅ | OK |
| 操縦者氏名 | ✅ | ✅ | OK |
| 操縦者技能証明番号 | ❌ | ✅ | **追加必要** |
| 無人航空機の登録記号 | ✅ | ✅ | OK |
| 機体名 | ✅ | ✅ | OK |
| 飛行目的 | ✅ | ✅ | OK |
| 飛行経路（概要） | ❌ | ✅ | **追加必要** |
| 特定飛行フラグ | ❌ | ✅ | **追加必要** |
| 飛行計画の通報 | ❌ | ✅（特定飛行時） | **追加必要** |
| 離陸場所 | ✅ | ✅ | OK |
| 離陸時刻 | ❌ | ✅ | **追加必要** |
| 着陸場所 | ❌ | ✅ | **追加必要** |
| 着陸時刻 | ❌ | ✅ | **追加必要** |
| 飛行時間 | ✅（分） | ✅ | OK（自動計算に変更） |
| 総飛行時間 | ❌ | ✅ | **追加必要（自動）** |
| 安全に影響事項 | ✅（notes） | ✅ | 分離が必要 |
| 不具合発生日 | ❌ | ✅ | **追加必要** |
| 不具合事項 | ❌ | ✅ | **追加必要** |
| 処置実施日 | ❌ | ✅ | **追加必要** |
| 処置内容 | ❌ | ✅ | **追加必要** |
| 確認者氏名 | ❌ | ✅ | **追加必要** |

#### B-2: FlightLogForm.tsx の改造手順

```typescript
// src/components/FlightLogForm.tsx の改造版
import React, { useState, useEffect } from 'react';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Textarea } from './ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { DatePicker } from './ui/date-picker';
import { LocationInput } from './LocationInput';
import { Checkbox } from './ui/checkbox';
import { Separator } from './ui/separator';

export function FlightLogForm({ onAddFlight, pilots, uavs, locations }) {
  const [formData, setFormData] = useState({
    // 基本情報
    flightDate: new Date(),
    droneId: '',
    operatorId: '',
    
    // 飛行詳細
    purpose: '',
    outline: '',  // 新規: 飛行経路概要
    isTokuteiFlight: false,  // 新規: 特定飛行フラグ
    flightPlanNotified: false,  // 新規: 飛行計画の通報
    
    // 離着陸情報
    takeoffLocationId: '',
    takeoffTime: '',  // 新規: HH:mm 形式
    landingLocationId: '',  // 新規: 着陸場所
    landingTime: '',  // 新規: HH:mm 形式
    // flightTimeMinutes は自動計算
    
    // 安全・不具合情報
    safetyImpactNote: '',  // 新規: 飛行の安全に影響のあった事項
    faultDate: null,  // 新規: 不具合発生日
    faultDetail: '',  // 新規: 不具合事項
    fixDate: null,  // 新規: 処置実施日
    fixDetail: '',  // 新規: 処置内容
    confirmerId: '',  // 新規: 確認者
  });

  const [currentStep, setCurrentStep] = useState(1);

  // 飛行時間の自動計算
  useEffect(() => {
    if (formData.takeoffTime && formData.landingTime) {
      const takeoff = new Date(`2000-01-01T${formData.takeoffTime}`);
      const landing = new Date(`2000-01-01T${formData.landingTime}`);
      const diffMs = landing.getTime() - takeoff.getTime();
      const diffMinutes = Math.round(diffMs / 60000);
      
      if (diffMinutes > 0) {
        // flightTimeMinutes を自動セット
        console.log(`飛行時間: ${diffMinutes}分`);
      }
    }
  }, [formData.takeoffTime, formData.landingTime]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>飛行記録（様式1）</CardTitle>
      </CardHeader>
      <CardContent>
        {currentStep === 1 && (
          <div className="space-y-6 md:space-y-4">
            <h3 className="text-xl font-medium mb-4 md:text-lg">基本情報</h3>
            
            {/* 飛行日 */}
            <div className="space-y-3 md:space-y-2">
              <Label>飛行年月日 *</Label>
              <DatePicker
                value={formData.flightDate}
                onChange={(date) => setFormData(prev => ({ ...prev, flightDate: date }))}
              />
            </div>

            {/* 機体選択 */}
            <div className="space-y-3 md:space-y-2">
              <Label>無人航空機 *</Label>
              <Select value={formData.droneId} onValueChange={(value) => setFormData(prev => ({ ...prev, droneId: value }))}>
                <SelectTrigger>
                  <SelectValue placeholder="機体を選択" />
                </SelectTrigger>
                <SelectContent>
                  {uavs.map(uav => (
                    <SelectItem key={uav.id} value={uav.id}>
                      {uav.registrationMark} - {uav.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* 操縦者選択 */}
            <div className="space-y-3 md:space-y-2">
              <Label>操縦者 *</Label>
              <Select value={formData.operatorId} onValueChange={(value) => setFormData(prev => ({ ...prev, operatorId: value }))}>
                <SelectTrigger>
                  <SelectValue placeholder="操縦者を選択" />
                </SelectTrigger>
                <SelectContent>
                  {pilots.map(pilot => (
                    <SelectItem key={pilot.id} value={pilot.id}>
                      {pilot.name} {pilot.licenseNumber && `（技能証明: ${pilot.licenseNumber}）`}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* 特定飛行フラグ */}
            <div className="space-y-3 md:space-y-2">
              <div className="flex items-center gap-3">
                <Checkbox
                  id="isTokuteiFlight"
                  checked={formData.isTokuteiFlight}
                  onCheckedChange={(checked) => setFormData(prev => ({ ...prev, isTokuteiFlight: checked as boolean }))}
                />
                <Label htmlFor="isTokuteiFlight" className="cursor-pointer">
                  特定飛行（カテゴリーⅡ・Ⅲ）
                </Label>
              </div>
              <p className="text-sm text-muted-foreground">
                ※ 人口集中地区での飛行、夜間飛行、目視外飛行等
              </p>
            </div>

            {/* 飛行計画の通報（特定飛行時のみ） */}
            {formData.isTokuteiFlight && (
              <div className="space-y-3 md:space-y-2 pl-6 border-l-2 border-blue-200">
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="flightPlanNotified"
                    checked={formData.flightPlanNotified}
                    onCheckedChange={(checked) => setFormData(prev => ({ ...prev, flightPlanNotified: checked as boolean }))}
                  />
                  <Label htmlFor="flightPlanNotified" className="cursor-pointer">
                    飛行計画の通報を実施
                  </Label>
                </div>
              </div>
            )}

            <Button onClick={() => setCurrentStep(2)} className="w-full" size="lg">
              次へ（飛行詳細）
            </Button>
          </div>
        )}

        {currentStep === 2 && (
          <div className="space-y-6 md:space-y-4">
            <h3 className="text-xl font-medium mb-4 md:text-lg">飛行詳細</h3>

            {/* 飛行目的 */}
            <div className="space-y-3 md:space-y-2">
              <Label>飛行目的 *</Label>
              <Select value={formData.purpose} onValueChange={(value) => setFormData(prev => ({ ...prev, purpose: value }))}>
                <SelectTrigger>
                  <SelectValue placeholder="目的を選択" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="撮影">空撮・撮影</SelectItem>
                  <SelectItem value="測量">測量・調査</SelectItem>
                  <SelectItem value="点検">インフラ点検</SelectItem>
                  <SelectItem value="農業">農業・農薬散布</SelectItem>
                  <SelectItem value="輸送">物資輸送</SelectItem>
                  <SelectItem value="訓練">訓練・練習</SelectItem>
                  <SelectItem value="その他">その他</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* 飛行経路概要 */}
            <div className="space-y-3 md:space-y-2">
              <Label>飛行経路の概要</Label>
              <Textarea
                value={formData.outline}
                onChange={(e) => setFormData(prev => ({ ...prev, outline: e.target.value }))}
                placeholder="例: A地点からB地点へ直線飛行、高度50m"
                rows={3}
              />
            </div>

            {/* 離陸場所 */}
            <div className="space-y-3 md:space-y-2">
              <Label>離陸場所 *</Label>
              <LocationInput
                value={formData.takeoffLocationId}
                onChange={(locationId) => setFormData(prev => ({ ...prev, takeoffLocationId: locationId }))}
                locations={locations}
              />
            </div>

            {/* 離陸時刻 */}
            <div className="space-y-3 md:space-y-2">
              <Label>離陸時刻 *</Label>
              <Input
                type="time"
                value={formData.takeoffTime}
                onChange={(e) => setFormData(prev => ({ ...prev, takeoffTime: e.target.value }))}
              />
            </div>

            {/* 着陸場所 */}
            <div className="space-y-3 md:space-y-2">
              <Label>着陸場所 *</Label>
              <LocationInput
                value={formData.landingLocationId}
                onChange={(locationId) => setFormData(prev => ({ ...prev, landingLocationId: locationId }))}
                locations={locations}
              />
            </div>

            {/* 着陸時刻 */}
            <div className="space-y-3 md:space-y-2">
              <Label>着陸時刻 *</Label>
              <Input
                type="time"
                value={formData.landingTime}
                onChange={(e) => setFormData(prev => ({ ...prev, landingTime: e.target.value }))}
              />
            </div>

            {/* 飛行時間（自動計算表示） */}
            {formData.takeoffTime && formData.landingTime && (
              <div className="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                <p className="text-sm text-blue-600 font-medium">飛行時間（自動計算）</p>
                <p className="text-lg text-blue-800 font-bold">
                  {/* 計算結果を表示 */}
                  XX分
                </p>
              </div>
            )}

            <div className="flex gap-3">
              <Button onClick={() => setCurrentStep(1)} variant="outline" className="flex-1">
                戻る
              </Button>
              <Button onClick={() => setCurrentStep(3)} className="flex-1" size="lg">
                次へ（安全・不具合）
              </Button>
            </div>
          </div>
        )}

        {currentStep === 3 && (
          <div className="space-y-6 md:space-y-4">
            <h3 className="text-xl font-medium mb-4 md:text-lg">安全・不具合情報</h3>

            {/* 飛行の安全に影響のあった事項 */}
            <div className="space-y-3 md:space-y-2">
              <Label>飛行の安全に影響のあった事項</Label>
              <Textarea
                value={formData.safetyImpactNote}
                onChange={(e) => setFormData(prev => ({ ...prev, safetyImpactNote: e.target.value }))}
                placeholder="例: 強風により一時ホバリング、電波干渉あり等"
                rows={3}
              />
              <p className="text-sm text-muted-foreground">
                ※ 特になければ空欄で構いません
              </p>
            </div>

            <Separator />

            {/* 不具合情報 */}
            <div className="p-4 bg-amber-50 border border-amber-200 rounded-xl space-y-4">
              <h4 className="font-medium text-amber-900">不具合が発生した場合のみ記入</h4>

              <div className="space-y-3 md:space-y-2">
                <Label>不具合発生日</Label>
                <DatePicker
                  value={formData.faultDate}
                  onChange={(date) => setFormData(prev => ({ ...prev, faultDate: date }))}
                  placeholder="日付を選択"
                />
              </div>

              <div className="space-y-3 md:space-y-2">
                <Label>不具合事項</Label>
                <Textarea
                  value={formData.faultDetail}
                  onChange={(e) => setFormData(prev => ({ ...prev, faultDetail: e.target.value }))}
                  placeholder="不具合の内容を詳しく記載"
                  rows={3}
                />
              </div>

              <div className="space-y-3 md:space-y-2">
                <Label>処置実施日</Label>
                <DatePicker
                  value={formData.fixDate}
                  onChange={(date) => setFormData(prev => ({ ...prev, fixDate: date }))}
                  placeholder="日付を選択"
                />
              </div>

              <div className="space-y-3 md:space-y-2">
                <Label>処置内容</Label>
                <Textarea
                  value={formData.fixDetail}
                  onChange={(e) => setFormData(prev => ({ ...prev, fixDetail: e.target.value }))}
                  placeholder="実施した処置を記載"
                  rows={3}
                />
              </div>

              <div className="space-y-3 md:space-y-2">
                <Label>確認者</Label>
                <Select value={formData.confirmerId} onValueChange={(value) => setFormData(prev => ({ ...prev, confirmerId: value }))}>
                  <SelectTrigger>
                    <SelectValue placeholder="確認者を選択" />
                  </SelectTrigger>
                  <SelectContent>
                    {pilots.map(pilot => (
                      <SelectItem key={pilot.id} value={pilot.id}>
                        {pilot.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="flex gap-3">
              <Button onClick={() => setCurrentStep(2)} variant="outline" className="flex-1">
                戻る
              </Button>
              <Button onClick={handleSubmit} className="flex-1" size="lg">
                記録を保存
              </Button>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

**ファイル**: `src/components/FlightLogForm.tsx` を上記のように拡張

---

### Phase C: 新規コンポーネントの作成

#### C-1: DailyInspectionForm.tsx の作成（2日）

日常点検記録（様式2）の完全実装。

**特徴**:
- 13項目のチェックリスト
- 各項目: 正常/異常/未選択 + 備考
- 「一括正常」ボタン
- 異常がある場合の警告

**ファイル**: `src/components/DailyInspectionForm.tsx`（新規作成）

#### C-2: MaintenanceRecordForm.tsx の作成（1日）

点検整備記録（様式3）の実装。

**ファイル**: `src/components/MaintenanceRecordForm.tsx`（新規作成）

#### C-3: ExportPanel.tsx の作成（1日）

CSV/Excel/PDF エクスポート画面。

**ファイル**: `src/components/ExportPanel.tsx`（新規作成）

---

### Phase D: App.tsx のナビゲーション再構成（1日）

現在の `activeTab` を様式別に拡張：

```typescript
type Tab = 'dashboard' | 'style1' | 'style2' | 'style3' | 'master' | 'export';
```

**ナビゲーション構造**:
```
├─ ダッシュボード
├─ 様式1: 飛行記録
├─ 様式2: 日常点検記録
├─ 様式3: 点検整備記録
├─ マスタ管理
│  ├─ 機体管理
│  ├─ 操縦者管理
│  └─ 場所管理
└─ エクスポート
```

---

## 📅 実装タイムライン

| 週 | Phase | タスク | 成果物 |
|----|-------|--------|--------|
| **Week 1** | A | データ構造移行 | 型定義・APIサービス層 |
| **Week 2** | B | FlightLogForm拡張 | 様式1完全対応 |
| **Week 3** | C-1 | DailyInspectionForm | 様式2実装 |
| **Week 4** | C-2, C-3 | MaintenanceForm + Export | 様式3 + エクスポート |
| **Week 5** | D | App.tsx再構成 | 統合・UI改善 |
| **Week 6** | テスト | E2Eテスト・調整 | リリース準備 |

---

## 🔄 マイグレーション戦略

### localStorage → API への段階的移行

#### ステップ1: Dual Write（両方に書き込み）
```typescript
const saveFlight = async (data) => {
  // localStorage に保存（後方互換性）
  const flights = JSON.parse(localStorage.getItem('flights') || '[]');
  flights.push(data);
  localStorage.setItem('flights', JSON.stringify(flights));

  // API にも送信（新システム）
  try {
    await flightLogApi.create(data);
  } catch (error) {
    console.error('API保存エラー:', error);
    // localStorage があるので処理は続行可能
  }
};
```

#### ステップ2: Dual Read（APIを優先、失敗時はlocalStorage）
```typescript
const getFlights = async () => {
  try {
    // まずAPIから取得を試みる
    return await flightLogApi.getAll();
  } catch (error) {
    console.warn('API取得エラー、localStorageから読み込みます');
    return JSON.parse(localStorage.getItem('flights') || '[]');
  }
};
```

#### ステップ3: API Only（localStorage は読み取り専用）
バックエンドが安定したら、localStorage は読み取り専用にし、新規保存は全てAPI経由に。

#### ステップ4: localStorage の削除
十分なテスト後、localStorage のコードを完全に削除。

---

## ✅ チェックリスト

### Phase A 完了条件
- [ ] `src/types/index.ts` が作成され、全ての型定義が完了
- [ ] `src/services/api.service.ts` が作成され、全てのAPI関数が定義
- [ ] `.env` に `VITE_API_BASE_URL` が設定
- [ ] API接続のテストコードが動作

### Phase B 完了条件
- [ ] `FlightLogForm.tsx` が様式1の全20項目に対応
- [ ] 離陸・着陸時刻から飛行時間が自動計算
- [ ] 特定飛行時の条件分岐が動作
- [ ] 不具合情報の入力が可能
- [ ] フォームバリデーションが動作

### Phase C 完了条件
- [ ] `DailyInspectionForm.tsx` が作成され、13項目チェック可能
- [ ] 「一括正常」ボタンが動作
- [ ] 異常時の警告ダイアログが表示
- [ ] `MaintenanceRecordForm.tsx` が作成され、整備記録入力可能
- [ ] `ExportPanel.tsx` が作成され、CSV/Excel/PDFボタンが配置

### Phase D 完了条件
- [ ] `App.tsx` のタブが様式別に再構成
- [ ] 各タブから対応するコンポーネントが表示
- [ ] ナビゲーションがスムーズに動作
- [ ] モバイル・デスクトップ両対応

---

## 🎯 優先度の設定

### 🔴 最優先（MVP必須）
- Phase A: データ構造・APIサービス層
- Phase B: FlightLogForm の様式1対応
- App.tsx の基本的なナビゲーション

### 🟡 高優先度（MVP+）
- Phase C-1: DailyInspectionForm
- Phase C-3: ExportPanel (CSV のみ)

### 🟢 中優先度（完全版）
- Phase C-2: MaintenanceRecordForm
- ExportPanel (Excel/PDF)

---

## 📞 サポート

質問や不明点がある場合:
1. 各 Phase の詳細実装計画を参照
2. `実装計画.md` の対応セクションを確認
3. 必要に応じて AI に具体的な質問をする

---

**改造計画ドキュメント終了**

次のステップ: `Phase A-1: 型定義の作成` から開始してください！

