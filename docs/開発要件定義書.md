# 無人航空機日誌システム 開発要件定義書

**バージョン**: 1.0  
**作成日**: 2025年11月13日  
**対象**: 特定飛行対応 無人航空機日誌 Web/モバイルアプリケーション

---

## 1. プロジェクト概要

### 1.1 目的
改正航空法および国土交通省「無人航空機の飛行日誌の取扱要領」に準拠した、特定飛行時の義務化された飛行日誌の作成・保存を支援するシステムを構築する。

### 1.2 法的背景
- **対象**: 無人航空機（ドローン）の特定飛行を行う操縦者・事業者
- **保存義務**: 飛行記録を3年間保存
- **必須様式**: 国土交通省指定の様式1〜3

### 1.3 参考システム
- DroneLog（CSV入出力形式、内部ID管理方式を参考）
- 国土交通省「無人航空機の飛行日誌の取扱いに関するガイドライン」

---

## 2. 必須機能要件

### 2.1 コア機能

#### 2.1.1 飛行記録（様式1）管理
**目的**: 各飛行ごとの詳細記録を管理

**必須フィールド**:
- 飛行年月日
- 操縦者氏名 / 操縦者技能証明番号
- 無人航空機の登録記号 / 機体名
- 飛行目的 / 飛行経路（概要）
- 特定飛行フラグ / 飛行計画の通報有無
- 離陸場所 / 離陸時刻
- 着陸場所 / 着陸時刻
- 飛行時間（自動計算可）
- 総飛行時間（製造後またはメーカー出荷後の累積）
- 飛行の安全に影響のあった事項
- 不具合発生日 / 不具合事項
- 処置実施日 / 処置内容 / 確認者氏名

**機能要件**:
- 1飛行の定義: 離陸から着陸までを1回とする
- 総飛行時間の自動累計（同一機体の過去記録から計算）
- 特定飛行フラグによる必須項目の変動
- 時刻の前後関係バリデーション

#### 2.1.2 日常点検記録（様式2）管理
**目的**: 飛行前・飛行後の日常点検記録を管理

**必須フィールド**:
- 無人航空機の登録記号
- 点検種別（飛行前点検 / 飛行後点検）
- 実施年月日
- 実施場所
- 実施者氏名

**点検項目** (各項目: 正常/異常/未選択 + 備考):
1. 機体全般
2. プロペラ
3. フレーム
4. 通信系統
5. 推進系統
6. 電源系統
7. 自動制御系統
8. 操縦装置
9. バッテリー・燃料
10. 機体識別表示
11. リモートID機能
12. 灯火
13. カメラ

**特記事項**: 日常点検特記事項（自由記述）

**ビジネスルール**:
- 飛行前点検で「異常」項目がある場合、飛行不可フラグを立てる
- 飛行後点検は任意だが記録推奨

#### 2.1.3 点検整備記録（様式3）管理
**目的**: 定期点検・修理・改造の記録を管理

**必須フィールド**:
- 無人航空機の登録記号
- 実施年月日
- 総飛行時間（その時点での累積時間）
- 点検・修理・改造及び整備の内容
- 実施理由
- 実施場所
- 実施者氏名
- その他特記事項（次回実施予定等）

**機能要件**:
- 新規作成時、機体の最新総飛行時間を自動取得
- 部品交換履歴の記録
- 次回メンテナンス予定日の設定・通知

#### 2.1.4 機体管理（無人航空機マスタ）
**必須フィールド**:
- 内部ID（ハッシュID形式）
- 無人航空機の登録記号（例: JU-XXXXXX）
- 機体名
- メーカー / 製造番号 / 型式
- 機体認証番号（任意）
- 所有組織ID
- 現在の総飛行時間
- 状態（運用中 / 整備中 / 退役）

#### 2.1.5 操縦者管理
**必須フィールド**:
- 内部ID
- 操縦者氏名
- 操縦者技能証明番号（任意）
- 所属組織ID
- 権限レベル（一般操縦者 / 管理者）

#### 2.1.6 場所管理
**必須フィールド**:
- 内部ID
- 場所名
- 住所・地番
- 緯度・経度
- 人口集中地区（DID）フラグ
- 飛行許可の要否

### 2.2 データ入出力機能

#### 2.2.1 CSV 入出力
**エクスポート仕様**:
- エンコーディング: BOM付き UTF-8
- 1行目: 日本語列名
- 内部ID: Base64 / URL-safe ハッシュID形式
- 日時: ISO 8601形式（例: 2025-09-19T13:22:00Z）
- 対象データ: 飛行記録 / 日常点検記録 / 点検整備記録 / 各マスタ

**インポート仕様**:
- 外部編集されたCSVの再取込
- 内部IDの存在確認
- 重複チェック
- バリデーションエラーの詳細レポート

#### 2.2.2 Excel 出力
**様式1（飛行記録）**:
列順: No / 飛行年月日 / 操縦者氏名 / 操縦者技能証明番号 / 無人航空機の登録記号 / 機体名 / 飛行目的 / 飛行経路 / 離陸場所 / 離陸時刻 / 着陸場所 / 着陸時刻 / 飛行時間 / 総飛行時間 / 飛行の安全に影響のあった事項 / 不具合発生日 / 不具合事項 / 処置実施日 / 処置内容 / 確認者氏名

**様式2（日常点検記録）**:
点検項目一覧表形式

**様式3（点検整備記録）**:
作業内容詳細記録形式

**共通仕様**:
- A4サイズ
- 会社名 / ロゴ挿入可能
- 自動ページ番号
- 印刷最適化

#### 2.2.3 PDF 出力
- HTML + CSS による版下作成
- Puppeteer / Playwright による PDF 変換
- 電子署名欄（将来対応）
- 一括ダウンロード（ZIP形式）

### 2.3 権限管理

#### 2.3.1 組織管理
- 複数組織（会社・事業所）のマルチテナント対応
- 組織ごとのデータ分離
- 組織間データ参照不可

#### 2.3.2 ユーザー権限
**一般操縦者**:
- 自分の飛行記録の作成・編集
- 自分が実施した点検記録の閲覧・編集
- 組織内の機体・場所マスタの参照

**管理者**:
- 組織内全記録の閲覧・編集・削除
- マスタデータの管理
- CSV/Excel/PDF エクスポート
- ユーザー管理

**システム管理者**:
- 全組織のデータ管理
- システム設定

### 2.4 その他機能要件

#### 2.4.1 データ保存義務対応
- 記録の論理削除（物理削除禁止）
- 保存期限の自動計算（作成日 + 3年）
- 保存期限切れ前の通知
- アーカイブ機能

#### 2.4.2 モバイル対応
- レスポンシブデザイン
- PWA（Progressive Web App）対応
- オフライン入力・同期機能（将来対応）
- タッチ操作最適化（既に実装済み）

#### 2.4.3 通知機能
- 飛行前点検の未実施警告
- メンテナンス時期の通知
- 総飛行時間が閾値到達時の通知

---

## 3. 技術仕様

### 3.1 推奨技術スタック

#### 3.1.1 フロントエンド
- **フレームワーク**: React 18.3 (既存)
- **言語**: TypeScript 5.7
- **状態管理**: React Hooks / Context API
- **UIライブラリ**: Radix UI (既存) + Tailwind CSS 3.4
- **地図**: Leaflet + React Leaflet (既に実装済み)
- **フォーム**: React Hook Form
- **日付**: date-fns 3.x
- **ビルドツール**: Vite 6.x (既存)

#### 3.1.2 バックエンド
- **ランタイム**: Node.js 20 LTS
- **フレームワーク**: Express.js または Fastify
- **言語**: TypeScript 5.x
- **ORM**: Prisma または TypeORM
- **認証**: JWT + bcrypt
- **バリデーション**: Zod または Joi

#### 3.1.3 データベース
- **RDBMS**: PostgreSQL 15+
- **キャッシュ**: Redis (セッション管理用、任意)

#### 3.1.4 インフラ
- **開発環境**: Docker Compose
- **本番環境**: クラウド（AWS / Azure / GCP）または オンプレミス
- **ファイルストレージ**: S3互換 または ローカルストレージ

#### 3.1.5 その他ライブラリ
- **Excel出力**: exceljs
- **CSV処理**: csv-parse / csv-stringify
- **PDF生成**: puppeteer
- **ID生成**: hashids または nanoid
- **ログ**: winston または pino

### 3.2 データベース設計

#### 3.2.1 主要テーブル

```sql
-- 組織（マルチテナント対応）
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  code VARCHAR(50) UNIQUE NOT NULL,
  address TEXT,
  phone VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ユーザー（操縦者）
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  license_number VARCHAR(50), -- 操縦者技能証明番号
  role VARCHAR(20) NOT NULL DEFAULT 'operator', -- operator / admin / system_admin
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_organization (organization_id),
  INDEX idx_email (email)
);

-- 無人航空機（機体）
CREATE TABLE drones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  registration_mark VARCHAR(50) NOT NULL, -- 登録記号（例: JU-123456）
  name VARCHAR(255) NOT NULL,
  manufacturer VARCHAR(255),
  model VARCHAR(255),
  serial_number VARCHAR(255),
  certification_number VARCHAR(100), -- 機体認証番号
  total_flight_hours DECIMAL(10,2) DEFAULT 0, -- 総飛行時間（時間）
  status VARCHAR(20) DEFAULT 'active', -- active / maintenance / retired
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP, -- 論理削除
  UNIQUE(organization_id, registration_mark),
  INDEX idx_organization (organization_id),
  INDEX idx_registration (registration_mark)
);

-- 飛行場所
CREATE TABLE locations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  name VARCHAR(255) NOT NULL,
  address TEXT,
  latitude DECIMAL(10,7),
  longitude DECIMAL(10,7),
  is_did BOOLEAN DEFAULT FALSE, -- 人口集中地区フラグ
  requires_permit BOOLEAN DEFAULT FALSE,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_organization (organization_id)
);

-- 飛行記録（様式1）
CREATE TABLE flight_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  drone_id UUID NOT NULL REFERENCES drones(id),
  operator_id UUID NOT NULL REFERENCES users(id),
  flight_date DATE NOT NULL,
  purpose TEXT NOT NULL, -- 飛行目的
  outline TEXT, -- 飛行概要・経路
  is_tokutei_flight BOOLEAN DEFAULT FALSE, -- 特定飛行フラグ
  flight_plan_notified BOOLEAN, -- 飛行計画の通報有無
  
  takeoff_location_id UUID REFERENCES locations(id),
  takeoff_time TIME NOT NULL,
  landing_location_id UUID REFERENCES locations(id),
  landing_time TIME NOT NULL,
  flight_time_minutes INTEGER, -- 飛行時間（分）
  total_time_since_manufactured DECIMAL(10,2), -- 製造後総飛行時間
  
  safety_impact_note TEXT, -- 飛行の安全に影響のあった事項
  fault_date DATE, -- 不具合発生日
  fault_detail TEXT, -- 不具合事項
  fix_date DATE, -- 処置実施日
  fix_detail TEXT, -- 処置内容
  confirmer_id UUID REFERENCES users(id), -- 確認者
  
  retention_until DATE NOT NULL, -- 保存期限（flight_date + 3年）
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP, -- 論理削除
  
  INDEX idx_drone_date (drone_id, flight_date),
  INDEX idx_organization (organization_id),
  INDEX idx_operator (operator_id)
);

-- 日常点検記録（様式2）
CREATE TABLE daily_inspections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  drone_id UUID NOT NULL REFERENCES drones(id),
  inspection_type VARCHAR(20) NOT NULL, -- pre-flight / post-flight
  execution_date DATE NOT NULL,
  execution_place_id UUID REFERENCES locations(id),
  executor_id UUID NOT NULL REFERENCES users(id),
  
  -- 点検項目（各項目: result + note）
  result_airframe VARCHAR(20), -- 正常/異常/未選択
  note_airframe TEXT,
  result_propeller VARCHAR(20),
  note_propeller TEXT,
  result_frame VARCHAR(20),
  note_frame TEXT,
  result_communication VARCHAR(20),
  note_communication TEXT,
  result_propulsion VARCHAR(20),
  note_propulsion TEXT,
  result_power VARCHAR(20),
  note_power TEXT,
  result_control VARCHAR(20),
  note_control TEXT,
  result_controller VARCHAR(20),
  note_controller TEXT,
  result_battery VARCHAR(20),
  note_battery TEXT,
  result_remote_id VARCHAR(20),
  note_remote_id TEXT,
  result_lights VARCHAR(20),
  note_lights TEXT,
  result_camera VARCHAR(20),
  note_camera TEXT,
  
  special_note TEXT, -- 日常点検特記事項
  overall_result VARCHAR(20), -- 正常/異常（自動判定）
  
  retention_until DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  INDEX idx_drone_date (drone_id, execution_date),
  INDEX idx_organization (organization_id)
);

-- 点検整備記録（様式3）
CREATE TABLE maintenance_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  drone_id UUID NOT NULL REFERENCES drones(id),
  execution_date DATE NOT NULL,
  total_flight_time_at_moment DECIMAL(10,2), -- その時点の総飛行時間
  work_content TEXT NOT NULL, -- 点検・修理・改造及び整備の内容
  reason TEXT, -- 実施理由
  execution_place_id UUID REFERENCES locations(id),
  executor_id UUID NOT NULL REFERENCES users(id),
  next_due_note TEXT, -- その他特記事項（次回予定等）
  
  retention_until DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  INDEX idx_drone_date (drone_id, execution_date),
  INDEX idx_organization (organization_id)
);
```

#### 3.2.2 インデックス戦略
- 組織IDによるフィルタリングが頻繁なため、各テーブルに organization_id のインデックス
- 機体ID + 日付の複合インデックス（飛行記録・点検記録の検索最適化）
- メールアドレス・登録記号などの一意制約フィールドにインデックス

### 3.3 API設計

#### 3.3.1 認証エンドポイント
```
POST   /api/auth/login
POST   /api/auth/logout
POST   /api/auth/refresh
GET    /api/auth/me
```

#### 3.3.2 飛行記録（様式1）
```
POST   /api/flight-logs              # 新規作成
GET    /api/flight-logs               # 一覧取得（query: drone_id, from, to, operator_id）
GET    /api/flight-logs/:id           # 詳細取得
PUT    /api/flight-logs/:id           # 更新
DELETE /api/flight-logs/:id           # 論理削除
GET    /api/flight-logs/export/csv    # CSV出力
GET    /api/flight-logs/export/excel  # Excel（様式1）出力
GET    /api/flight-logs/export/pdf    # PDF出力
```

#### 3.3.3 日常点検記録（様式2）
```
POST   /api/daily-inspections
GET    /api/daily-inspections
GET    /api/daily-inspections/:id
PUT    /api/daily-inspections/:id
DELETE /api/daily-inspections/:id
GET    /api/daily-inspections/export/csv
GET    /api/daily-inspections/export/excel
GET    /api/daily-inspections/export/pdf
```

#### 3.3.4 点検整備記録（様式3）
```
POST   /api/maintenance-records
GET    /api/maintenance-records
GET    /api/maintenance-records/:id
PUT    /api/maintenance-records/:id
DELETE /api/maintenance-records/:id
GET    /api/maintenance-records/export/csv
GET    /api/maintenance-records/export/excel
GET    /api/maintenance-records/export/pdf
```

#### 3.3.5 マスタデータ
```
# 機体管理
GET    /api/drones
POST   /api/drones
GET    /api/drones/:id
PUT    /api/drones/:id
DELETE /api/drones/:id

# 操縦者管理
GET    /api/users
POST   /api/users
GET    /api/users/:id
PUT    /api/users/:id
DELETE /api/users/:id

# 場所管理
GET    /api/locations
POST   /api/locations
GET    /api/locations/:id
PUT    /api/locations/:id
DELETE /api/locations/:id
```

#### 3.3.6 一括エクスポート
```
POST   /api/export/bulk               # ZIP形式で様式1〜3の全データを出力
```

### 3.4 バックエンド アーキテクチャ

#### 3.4.1 レイヤー構成
```
src/
├── controllers/          # リクエストハンドラ
│   ├── auth.controller.ts
│   ├── flight-logs.controller.ts
│   ├── daily-inspections.controller.ts
│   ├── maintenance-records.controller.ts
│   └── ...
├── services/             # ビジネスロジック
│   ├── flight-logs.service.ts
│   ├── total-time-calculator.service.ts
│   └── ...
├── repositories/         # データアクセス層
│   ├── flight-logs.repository.ts
│   └── ...
├── middleware/           # 認証・バリデーション等
│   ├── auth.middleware.ts
│   ├── validate.middleware.ts
│   └── error-handler.middleware.ts
├── models/               # TypeScript型定義 / DTOs
│   ├── flight-log.model.ts
│   └── ...
├── utils/                # ユーティリティ
│   ├── hash-id.util.ts
│   ├── csv-exporter.util.ts
│   ├── excel-exporter.util.ts
│   ├── pdf-generator.util.ts
│   └── date.util.ts
└── validators/           # Zodスキーマ
    ├── flight-log.validator.ts
    └── ...
```

#### 3.4.2 処理フロー例（飛行記録作成）
1. Controller: リクエスト受信・認証確認
2. Validator: Zodによる入力検証
3. Service: ビジネスロジック実行
   - 機体の存在確認
   - 離着陸時刻の妥当性チェック
   - 総飛行時間の自動計算（過去記録から累積）
   - 保存期限の設定（flight_date + 3年）
4. Repository: DBへの保存
5. Controller: レスポンス返却

---

## 4. 非機能要件

### 4.1 パフォーマンス
- ページ読み込み時間: 3秒以内
- API レスポンス時間: 1秒以内（通常操作）
- Excel/PDF出力: 10秒以内（1000件程度）

### 4.2 セキュリティ
- パスワード: bcrypt によるハッシュ化
- 通信: HTTPS 必須
- 認証: JWT（有効期限: 1時間、リフレッシュトークン: 30日）
- CSRF 対策
- SQL インジェクション対策（ORMの利用）
- XSS 対策（入力サニタイズ）

### 4.3 可用性
- 稼働率: 99.5% 以上（オンプレミスの場合は除く）
- データバックアップ: 日次

### 4.4 拡張性
- 機体数: 10,000台まで対応
- ユーザー数: 1,000人まで対応
- 飛行記録: 100万件まで対応

### 4.5 保守性
- コードレビュー必須
- ユニットテスト カバレッジ 70% 以上
- API ドキュメント（OpenAPI / Swagger）
- エラーログの一元管理

---

## 5. 開発スケジュール（概算）

### Phase 1: 基盤構築（2週間）
- [ ] データベース設計・構築
- [ ] バックエンド基本構造（Express + TypeScript）
- [ ] 認証機能
- [ ] マスタデータ管理API

### Phase 2: コア機能実装（4週間）
- [ ] 飛行記録（様式1）CRUD
- [ ] 日常点検記録（様式2）CRUD
- [ ] 点検整備記録（様式3）CRUD
- [ ] 総飛行時間の自動計算ロジック

### Phase 3: データ入出力（2週間）
- [ ] CSV入出力
- [ ] Excel出力（様式1〜3）
- [ ] PDF出力
- [ ] 一括エクスポート（ZIP）

### Phase 4: フロントエンド実装（3週間）
- [ ] 既存UIの再構成（様式対応）
- [ ] 飛行記録フォーム
- [ ] 日常点検フォーム（チェックリスト形式）
- [ ] 点検整備フォーム
- [ ] マスタ管理画面

### Phase 5: テスト・調整（2週間）
- [ ] 単体テスト
- [ ] 結合テスト
- [ ] ユーザー受入テスト（UAT）
- [ ] パフォーマンステスト

### Phase 6: デプロイ・運用開始（1週間）
- [ ] 本番環境構築
- [ ] データ移行
- [ ] 運用マニュアル作成
- [ ] ユーザートレーニング

**合計**: 約 14週間（3.5ヶ月）

---

## 6. リスクと対策

### 6.1 法規制変更リスク
- **リスク**: 国土交通省のガイドライン変更
- **対策**: 様式定義を設定ファイル化、柔軟に対応可能な設計

### 6.2 データ損失リスク
- **リスク**: システム障害・人的ミス
- **対策**: 日次バックアップ、論理削除の徹底、監査ログ

### 6.3 スケジュール遅延リスク
- **リスク**: 要件追加・仕様変更
- **対策**: MVP（最小限の機能）先行リリース、段階的機能追加

### 6.4 セキュリティリスク
- **リスク**: 不正アクセス・情報漏洩
- **対策**: 多層防御、定期的なセキュリティ監査、ペネトレーションテスト

---

## 7. 成功基準

1. **法令遵守**: 国土交通省ガイドラインに完全準拠
2. **データ精度**: 総飛行時間の自動計算誤差 0.1時間以内
3. **ユーザビリティ**: 飛行記録入力時間 5分以内（平均）
4. **出力品質**: Excel/PDF が国交省様式と視覚的に同等
5. **保存義務**: 3年間のデータ保持・即座にエクスポート可能

---

## 8. 参考資料

- [国土交通省「無人航空機の飛行日誌の取扱いに関するガイドライン」](https://www.mlit.go.jp/)
- [改正航空法](https://elaws.e-gov.go.jp/)
- DroneLog システム仕様（参考）

---

**ドキュメント終了**

