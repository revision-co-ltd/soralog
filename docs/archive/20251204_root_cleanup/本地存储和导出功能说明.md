# 本地存储和导出功能说明

## 已完成的改进 ✅

### 1. 数据自动保存到本地 💾

**所有数据现在都会自动保存到浏览器的localStorage中**，包括：

- ✈️ 飞行记录 (flightLogs)
- 👤 操纵者信息 (pilots)
- 🚁 机体信息 (uavs)
- 📋 日常点检记录 (dailyInspections)
- 🔧 点检整备记录 (maintenanceRecords)

**优点：**
- 刷新页面数据不会丢失
- 关闭浏览器后数据依然保存
- 无需网络连接也能保存数据

### 2. 本地导出功能 📤

**新增了"本地数据导出"功能**，可以在"履歴"标签页中导出数据：

#### 飞行记录导出
- **CSV格式**：可用Excel打开，不会乱码
- **JSON格式**：完整的数据备份，可用于恢复
- **日期筛选**：可选择导出指定日期范围的数据

#### 日常点检记录导出
- **CSV格式**：包含点检日期、机体、操作者、结果等信息

#### 点检整备记录导出
- **CSV格式**：包含整备日期、机体、担当者、内容等信息

### 3. 离线保存优化 🔄

**改进了日常点检和点检整备记录的保存逻辑：**

1. **优先保存到本地**：无论网络状态如何，数据先保存到localStorage
2. **然后尝试同步**：如果网络可用，自动同步到服务器
3. **容错处理**：即使同步失败，本地数据依然安全

**用户体验改进：**
- 即使服务器连接失败（401错误），数据也不会丢失
- 离线状态下可以正常添加记录
- 网络恢复后会自动同步

## 使用方法

### 导出飞行记录

1. 点击底部导航栏的 **"履歴"**
2. 在履歴页面，您可以看到所有的飞行记录
3. 点击页面上的 **"导出"** 按钮（或前往"その他" → "エクスポート・設定"）
4. 选择：
   - **日期范围**（可选）：只导出特定时间段的数据
   - **CSV导出**：适合用Excel查看和编辑
   - **JSON导出**：适合数据备份

### 导出日常点检记录

1. 前往 **"その他"** → **"エクスポート・設定"**
2. 在"日常点检记录（様式2）"部分
3. 点击 **"CSV出力"**

### 导出点检整备记录

1. 前往 **"その他"** → **"エクスポート・設定"**
2. 在"点检整备记录（様式3）"部分
3. 点击 **"CSV出力"**

## CSV导出内容

### 飞行记录CSV包含的字段：

| 字段 | 说明 |
|------|------|
| 飛行日 | 飞行日期和时间 |
| 操縦者 | 操纵者姓名 |
| 使用機体 | 使用的无人机 |
| 飛行場所 | 飞行地点（详细地址）|
| 飛行時間（分）| 飞行时长（分钟）|
| 飛行目的 | 飞行目的 |
| 特定飛行 | 是否为特定飞行 |
| 飛行計画通報 | 是否已通报飞行计划 |
| 飛行概要 | 飞行概要 |
| 天候 | 天气状况 |
| 緯度 | GPS纬度 |
| 経度 | GPS经度 |

## 故障排除

### Q: 找不到导出按钮？
**A:** 导出功能在两个地方：
1. "履歴"页面（飞行记录）
2. "その他" → "エクスポート・設定"（所有记录）

### Q: 日常点检记录显示"没有数据"？
**A:** 这是因为还没有添加任何日常点检记录。请先：
1. 在首页选择"様式2"（日常点检记录）
2. 填写并提交一条点检记录
3. 然后再尝试导出

### Q: CSV在Excel中打开乱码？
**A:** 正常情况下不会乱码，因为：
- 使用了BOM标记的UTF-8编码
- Excel会自动识别并正确显示日文

如果还是乱码：
- 尝试用记事本打开CSV，另存为UTF-8编码
- 或在Excel中使用"数据" → "从文本导入"功能

### Q: 数据会在什么情况下丢失？
**A:** 数据保存在浏览器中，以下情况会导致数据丢失：
- 清除浏览器缓存/数据
- 卸载浏览器
- 使用隐私/无痕模式（关闭后数据清除）

**建议：定期导出数据作为备份！**

### Q: 之前的数据去哪了？
**A:** 如果您在此次更新之前添加的数据没有显示：
- 旧数据可能只保存在服务器上
- localStorage是新增功能，之前的数据需要重新添加
- 或者从服务器重新同步（如果有备份）

## 技术细节

### 数据存储位置
- 浏览器localStorage
- 可通过浏览器开发者工具查看：F12 → Application → Local Storage

### 数据格式
- JSON格式存储
- 每个记录类型一个键值对
- 自动序列化和反序列化

### 自动保存时机
- 添加新记录时
- 修改记录时
- 删除记录时
- 使用React的useEffect自动触发

## 注意事项

⚠️ **重要提醒：**

1. **定期备份**：虽然数据保存在本地，但建议定期导出CSV或JSON作为备份
2. **存储限制**：浏览器localStorage通常限制5-10MB，记录过多时请及时导出并清理
3. **隐私模式**：在浏览器隐私/无痕模式下，数据在关闭窗口后会被清除
4. **多设备**：数据保存在单个设备上，不会自动同步到其他设备

## 未来计划

🚀 **可能的后续改进：**

1. **JSON导入功能**：可以导入之前导出的JSON文件恢复数据
2. **自动备份**：定期自动下载备份文件
3. **云端同步**：在多个设备间同步数据
4. **PDF导出**：直接在浏览器中生成PDF报告
5. **数据统计**：导出时包含统计图表

## 问题反馈

如果遇到任何问题或有改进建议，请：
- 查看浏览器控制台的错误信息（F12 → Console）
- 记录重现步骤
- 提供错误截图








