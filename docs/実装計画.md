# 無人航空機日誌システム 実装計画

**作成日**: 2025年11月13日  
**対象**: 段階的実装ロードマップ

---

## 実装アプローチ

既存のプロトタイプ（移動端優化済み）を基盤に、段階的に国交省様式対応の完全システムに移行する。

---

## Phase 1: データベース設計・構築 ✅ 優先度: 最高

### 1.1 データベースセットアップ
- [ ] PostgreSQL のセットアップ（Docker Compose）
- [ ] Prisma ORM の導入
- [ ] スキーマ定義（organizations, users, drones, locations, flight_logs, daily_inspections, maintenance_records）
- [ ] マイグレーションファイル作成
- [ ] シードデータ作成（テスト用）

### 1.2 内部ID管理
- [ ] ハッシュID生成ユーティリティ（hashids / nanoid）
- [ ] UUID ↔ ハッシュID 変換関数

**完了目標**: すべてのテーブルが作成され、基本的なリレーションが確立されている

**所要時間**: 3日

---

## Phase 2: バックエンド基盤構築 ✅ 優先度: 最高

### 2.1 プロジェクトセットアップ
- [ ] `backend/` ディレクトリ作成
- [ ] Express + TypeScript 環境構築
- [ ] ディレクトリ構造（controllers / services / repositories / middleware）
- [ ] 環境変数管理（.env）
- [ ] CORS・ヘルメット等のセキュリティ設定

### 2.2 認証機能
- [ ] JWT 生成・検証ロジック
- [ ] bcrypt によるパスワードハッシュ化
- [ ] POST /api/auth/login
- [ ] POST /api/auth/register
- [ ] GET /api/auth/me
- [ ] 認証ミドルウェア（authMiddleware）

### 2.3 共通ミドルウェア
- [ ] エラーハンドリングミドルウェア
- [ ] バリデーションミドルウェア（Zod）
- [ ] ロギングミドルウェア（winston / pino）

**完了目標**: ログイン・ユーザー情報取得ができ、認証が機能している

**所要時間**: 4日

---

## Phase 3: マスタデータ管理 ✅ 優先度: 高

### 3.1 機体管理（Drones）
- [ ] Zod バリデーションスキーマ
- [ ] DroneRepository（CRUD）
- [ ] DroneService（ビジネスロジック）
- [ ] DroneController
- [ ] API エンドポイント（GET, POST, PUT, DELETE /api/drones）

### 3.2 操縦者管理（Users）
- [ ] UserRepository
- [ ] UserService
- [ ] UserController
- [ ] API エンドポイント（GET, POST, PUT, DELETE /api/users）

### 3.3 場所管理（Locations）
- [ ] LocationRepository
- [ ] LocationService（緯度経度バリデーション、DIDフラグ管理）
- [ ] LocationController
- [ ] API エンドポイント（GET, POST, PUT, DELETE /api/locations）

**完了目標**: すべてのマスタデータが管理でき、APIが動作している

**所要時間**: 3日

---

## Phase 4: 飛行記録（様式1）実装 ✅ 優先度: 最高

### 4.1 バックエンド
- [ ] FlightLog Zod スキーマ
- [ ] FlightLogRepository
- [ ] FlightLogService
  - [ ] 総飛行時間の自動計算ロジック
  - [ ] 飛行時間の自動計算（着陸時刻 - 離陸時刻）
  - [ ] 保存期限の自動設定（flight_date + 3年）
  - [ ] 時刻前後関係バリデーション
- [ ] FlightLogController
- [ ] API エンドポイント（CRUD）

### 4.2 フロントエンド
- [ ] 既存 FlightLogForm の拡張
  - [ ] 操縦者技能証明番号フィールド追加
  - [ ] 特定飛行フラグ・飛行計画通報フラグ追加
  - [ ] 離着陸場所・時刻の分離
  - [ ] 不具合記録フィールド追加
  - [ ] 確認者選択フィールド追加
- [ ] 飛行記録一覧画面の強化
  - [ ] フィルタリング（機体・期間・操縦者）
  - [ ] ソート機能
  - [ ] ページネーション
- [ ] 飛行記録詳細・編集画面

### 4.3 総飛行時間の自動累計
- [ ] 同一機体の過去記録を時系列に取得
- [ ] 飛行時間の合計を計算
- [ ] 新規作成時に自動セット

**完了目標**: 飛行記録の作成・編集・一覧表示が完全に機能し、総飛行時間が正確に計算される

**所要時間**: 5日

---

## Phase 5: 日常点検記録（様式2）実装 ✅ 優先度: 高

### 5.1 バックエンド
- [ ] DailyInspection Zod スキーマ
- [ ] DailyInspectionRepository
- [ ] DailyInspectionService
  - [ ] 点検項目の結果集計ロジック
  - [ ] 「異常」がある場合の飛行不可フラグ設定
- [ ] DailyInspectionController
- [ ] API エンドポイント（CRUD）

### 5.2 フロントエンド
- [ ] 日常点検フォームコンポーネント
  - [ ] 点検種別選択（飛行前/飛行後）
  - [ ] 点検項目チェックリスト（13項目）
  - [ ] 各項目: 正常/異常/未選択 ラジオボタン + 備考テキスト
  - [ ] 「一括正常」ボタン
  - [ ] 特記事項入力欄
- [ ] 点検記録一覧画面
- [ ] 点検記録詳細・編集画面

### 5.3 UX 最適化
- [ ] モバイル版チェックリストUI（大きなタップ領域）
- [ ] 飛行前点検で異常がある場合の警告ダイアログ
- [ ] 飛行記録作成前に飛行前点検の実施確認

**完了目標**: 飛行前・飛行後の日常点検が記録でき、異常時の飛行不可フラグが機能する

**所要時間**: 4日

---

## Phase 6: 点検整備記録（様式3）実装 ✅ 優先度: 中

### 6.1 バックエンド
- [ ] MaintenanceRecord Zod スキーマ
- [ ] MaintenanceRecordRepository
- [ ] MaintenanceRecordService
  - [ ] 作成時に機体の最新総飛行時間を自動取得
  - [ ] 次回メンテナンス予定日の計算
- [ ] MaintenanceRecordController
- [ ] API エンドポイント（CRUD）

### 6.2 フロントエンド
- [ ] 点検整備記録フォームコンポーネント
  - [ ] 実施内容（複数行テキスト）
  - [ ] 実施理由
  - [ ] 次回予定メモ
- [ ] 点検整備記録一覧画面
  - [ ] タイムライン表示
- [ ] 点検整備記録詳細・編集画面

### 6.3 メンテナンス通知
- [ ] 総飛行時間が閾値到達時の通知
- [ ] 次回メンテナンス予定日が近づいた時の通知

**完了目標**: 点検整備記録が作成でき、メンテナンス履歴が確認できる

**所要時間**: 3日

---

## Phase 7: CSV入出力機能 ✅ 優先度: 高

### 7.1 CSV エクスポート
- [ ] csv-stringify ライブラリ統合
- [ ] BOM付き UTF-8 エンコーディング
- [ ] ハッシュID変換ユーティリティ
- [ ] 飛行記録 CSV エクスポート
- [ ] 日常点検記録 CSV エクスポート
- [ ] 点検整備記録 CSV エクスポート
- [ ] マスタデータ CSV エクスポート

### 7.2 CSV インポート
- [ ] csv-parse ライブラリ統合
- [ ] バリデーション（内部ID存在確認、重複チェック）
- [ ] エラーレポート生成
- [ ] 飛行記録 CSV インポート
- [ ] 日常点検記録 CSV インポート
- [ ] 点検整備記録 CSV インポート

**完了目標**: すべてのデータがCSV形式で入出力でき、DroneLog互換のフォーマットになっている

**所要時間**: 3日

---

## Phase 8: Excel出力機能 ✅ 優先度: 高

### 8.1 exceljs 統合
- [ ] exceljs ライブラリのセットアップ
- [ ] 様式テンプレート作成ユーティリティ

### 8.2 様式1（飛行記録）Excel出力
- [ ] 国交省様式1の列定義
- [ ] データ取得・変換ロジック
- [ ] exportFlightLogsToMLITStyle1() 関数
- [ ] API エンドポイント: GET /api/flight-logs/export/excel

### 8.3 様式2（日常点検記録）Excel出力
- [ ] 国交省様式2の列定義
- [ ] exportDailyInspectionsToMLITStyle2() 関数
- [ ] API エンドポイント: GET /api/daily-inspections/export/excel

### 8.4 様式3（点検整備記録）Excel出力
- [ ] 国交省様式3の列定義
- [ ] exportMaintenanceRecordsToMLITStyle3() 関数
- [ ] API エンドポイント: GET /api/maintenance-records/export/excel

**完了目標**: 国交省様式1〜3のExcelファイルが生成できる

**所要時間**: 4日

---

## Phase 9: PDF出力機能 ✅ 優先度: 中

### 9.1 Puppeteer 統合
- [ ] puppeteer ライブラリのセットアップ
- [ ] PDF生成ユーティリティ

### 9.2 HTMLテンプレート作成
- [ ] 様式1 HTMLテンプレート（A4、会社ロゴ対応）
- [ ] 様式2 HTMLテンプレート
- [ ] 様式3 HTMLテンプレート
- [ ] CSS スタイリング（印刷最適化）

### 9.3 PDF生成API
- [ ] GET /api/flight-logs/export/pdf
- [ ] GET /api/daily-inspections/export/pdf
- [ ] GET /api/maintenance-records/export/pdf

**完了目標**: 様式1〜3のPDFが生成でき、印刷に適したレイアウトになっている

**所要時間**: 3日

---

## Phase 10: 一括エクスポート（ZIP） ✅ 優先度: 中

### 10.1 ZIP生成
- [ ] archiver / jszip ライブラリ統合
- [ ] 複数ファイルのZIP圧縮

### 10.2 一括エクスポートAPI
- [ ] POST /api/export/bulk
- [ ] パラメータ: 機体ID、期間、フォーマット（Excel/PDF）
- [ ] 様式1〜3 + マスタデータの一括出力
- [ ] ファイル名規則（例: drone_JU123456_20250101-20251231.zip）

**完了目標**: 指定期間の全記録を1つのZIPファイルでダウンロードできる

**所要時間**: 2日

---

## Phase 11: フロントエンド統合・UI/UX改善 ✅ 優先度: 高

### 11.1 ナビゲーション再構成
- [ ] メインメニューの刷新（様式別タブ）
- [ ] 様式1: 飛行記録
- [ ] 様式2: 日常点検記録
- [ ] 様式3: 点検整備記録
- [ ] マスタ管理（機体・操縦者・場所）
- [ ] エクスポート

### 11.2 ダッシュボード強化
- [ ] 総飛行時間サマリー（機体別）
- [ ] 直近の飛行記録
- [ ] 点検・メンテナンス予定
- [ ] アラート（飛行前点検未実施、メンテナンス時期到来）

### 11.3 検索・フィルタ機能
- [ ] 高度な検索フォーム
- [ ] 保存済み検索条件
- [ ] クイックフィルタ

### 11.4 モバイル最適化
- [ ] タブレット対応
- [ ] PWA対応（オフライン表示）
- [ ] タッチ操作の改善（既存の最適化を維持）

**完了目標**: すべての機能が直感的に操作でき、モバイル・デスクトップで最適化されている

**所要時間**: 5日

---

## Phase 12: 組織・権限管理 ✅ 優先度: 中

### 12.1 組織管理
- [ ] Organization モデル・API
- [ ] 組織作成・編集画面
- [ ] 組織切り替え機能

### 12.2 権限管理
- [ ] ロールベースアクセス制御（RBAC）
- [ ] 一般操縦者: 自分の記録のみ編集可能
- [ ] 管理者: 組織内全記録の管理
- [ ] システム管理者: 全組織の管理

### 12.3 データ分離
- [ ] 組織IDによるフィルタリング（全クエリ）
- [ ] テナント分離の徹底

**完了目標**: 複数組織が同一システムを利用でき、データが完全に分離されている

**所要時間**: 3日

---

## Phase 13: テスト・品質保証 ✅ 優先度: 高

### 13.1 ユニットテスト
- [ ] Jest / Vitest セットアップ
- [ ] Service層のテスト（総飛行時間計算、バリデーション等）
- [ ] Repository層のテスト（モック使用）
- [ ] カバレッジ測定（目標: 70%以上）

### 13.2 統合テスト
- [ ] Supertest によるAPI統合テスト
- [ ] 飛行記録作成→点検記録作成→エクスポート の一連の流れ

### 13.3 E2Eテスト
- [ ] Playwright / Cypress セットアップ
- [ ] 主要ユースケースのE2Eテスト
  - [ ] ログイン→飛行記録作成→CSV出力
  - [ ] 日常点検→異常検出→飛行不可確認

### 13.4 パフォーマンステスト
- [ ] k6 / Artillery による負荷テスト
- [ ] 大量データ（10万件）での動作確認

**完了目標**: すべての主要機能がテストされ、カバレッジが目標を達成している

**所要時間**: 5日

---

## Phase 14: ドキュメント作成 ✅ 優先度: 中

### 14.1 技術ドキュメント
- [ ] API仕様書（OpenAPI / Swagger）
- [ ] データベーススキーマドキュメント
- [ ] 環境構築手順書

### 14.2 ユーザーマニュアル
- [ ] 飛行記録の作成方法
- [ ] 日常点検の実施方法
- [ ] CSV/Excel/PDFの出力方法
- [ ] よくある質問（FAQ）

### 14.3 運用マニュアル
- [ ] デプロイ手順
- [ ] バックアップ・リストア手順
- [ ] トラブルシューティング

**完了目標**: すべてのドキュメントが整備され、新規開発者・ユーザーが迷わず利用できる

**所要時間**: 3日

---

## Phase 15: デプロイ・運用開始 ✅ 優先度: 高

### 15.1 本番環境構築
- [ ] サーバーのセットアップ（クラウド or オンプレミス）
- [ ] PostgreSQL の本番環境設定
- [ ] SSL証明書の設定
- [ ] 環境変数の設定

### 15.2 CI/CD パイプライン
- [ ] GitHub Actions / GitLab CI
- [ ] 自動テスト実行
- [ ] 自動デプロイ

### 15.3 監視・ログ
- [ ] エラーログの集約（Sentry / LogRocket）
- [ ] パフォーマンス監視（New Relic / DataDog）
- [ ] アップタイム監視

### 15.4 データ移行
- [ ] 既存データのマイグレーション（ある場合）
- [ ] マスタデータの初期投入

**完了目標**: システムが本番環境で安定稼働し、監視体制が整っている

**所要時間**: 4日

---

## 総所要時間: 約 56日（約12週間）

---

## 優先順位付け（MVP版の定義）

### MVP（最小限の機能）に含めるべき機能:
1. ✅ データベース構築
2. ✅ 認証機能
3. ✅ 機体・操縦者・場所のマスタ管理
4. ✅ 飛行記録（様式1）CRUD
5. ✅ 総飛行時間の自動計算
6. ✅ CSV 出力（飛行記録のみ）
7. ✅ 基本的なフロントエンド

### MVP後に追加する機能:
8. 日常点検記録（様式2）
9. 点検整備記録（様式3）
10. Excel/PDF 出力
11. 組織・権限管理
12. 高度な検索・フィルタ

---

## 実装開始の準備

### 次のステップ:
1. **Docker Compose で PostgreSQL をセットアップ**
2. **バックエンドディレクトリを作成し、Express + TypeScript を初期化**
3. **Prisma をセットアップし、最初のマイグレーションを実行**
4. **認証APIを実装**

---

**実装計画ドキュメント終了**

