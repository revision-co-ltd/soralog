// Prisma Schema for 無人航空機日誌システム
// 国土交通省ガイドライン準拠

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 組織（マルチテナント対応）
model Organization {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  drones             Drone[]
  locations          Location[]
  flightLogs         FlightLog[]
  dailyInspections   DailyInspection[]
  maintenanceRecords MaintenanceRecord[]

  @@map("organizations")
}

// ユーザー（操縦者）
model User {
  id             String   @id @default(uuid())
  organizationId String
  email          String   @unique
  password       String
  name           String
  licenseNumber  String?
  role           Role     @default(OPERATOR)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization           Organization        @relation(fields: [organizationId], references: [id])
  operatedFlights        FlightLog[]         @relation("FlightOperator")
  confirmedFlights       FlightLog[]         @relation("FlightConfirmer")
  executedInspections    DailyInspection[]
  executedMaintenances   MaintenanceRecord[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

enum Role {
  OPERATOR
  ADMIN
  SYSTEM_ADMIN
}

// 無人航空機（機体）
model Drone {
  id                   String   @id @default(uuid())
  organizationId       String
  registrationMark     String   @unique // 登録記号（必須）
  name                 String
  manufacturer         String?
  model                String?
  serialNumber         String?
  certificationNumber  String?
  totalFlightHours     Float    @default(0)
  status               DroneStatus @default(ACTIVE)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deletedAt            DateTime?

  organization        Organization        @relation(fields: [organizationId], references: [id])
  flightLogs          FlightLog[]
  dailyInspections    DailyInspection[]
  maintenanceRecords  MaintenanceRecord[]

  @@index([organizationId])
  @@index([registrationMark])
  @@map("drones")
}

enum DroneStatus {
  ACTIVE
  MAINTENANCE
  RETIRED
}

// 飛行場所
model Location {
  id              String   @id @default(uuid())
  organizationId  String
  name            String
  address         String?
  latitude        Float?
  longitude       Float?
  isDid           Boolean  @default(false) // 人口集中地区フラグ
  requiresPermit  Boolean  @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization               Organization        @relation(fields: [organizationId], references: [id])
  takeoffFlights             FlightLog[]         @relation("TakeoffLocation")
  landingFlights             FlightLog[]         @relation("LandingLocation")
  dailyInspections           DailyInspection[]
  maintenanceRecords         MaintenanceRecord[]

  @@index([organizationId])
  @@map("locations")
}

// 様式1: 飛行記録
model FlightLog {
  id                        String    @id @default(uuid())
  organizationId            String
  droneId                   String
  operatorId                String
  flightDate                DateTime
  
  purpose                   String
  outline                   String?
  isTokuteiFlight           Boolean   @default(false)
  flightPlanNotified        Boolean?
  
  takeoffLocationId         String?
  takeoffTime               String // HH:mm
  landingLocationId         String?
  landingTime               String // HH:mm
  flightTimeMinutes         Int?
  totalTimeSinceManufactured Float?
  
  safetyImpactNote          String?
  faultDate                 DateTime?
  faultDetail               String?
  fixDate                   DateTime?
  fixDetail                 String?
  confirmerId               String?
  
  retentionUntil            DateTime // flightDate + 3年
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  deletedAt                 DateTime?

  organization    Organization @relation(fields: [organizationId], references: [id])
  drone           Drone        @relation(fields: [droneId], references: [id])
  operator        User         @relation("FlightOperator", fields: [operatorId], references: [id])
  takeoffLocation Location?    @relation("TakeoffLocation", fields: [takeoffLocationId], references: [id])
  landingLocation Location?    @relation("LandingLocation", fields: [landingLocationId], references: [id])
  confirmer       User?        @relation("FlightConfirmer", fields: [confirmerId], references: [id])

  @@index([organizationId])
  @@index([droneId])
  @@index([operatorId])
  @@index([flightDate])
  @@map("flight_logs")
}

// 様式2: 日常点検記録
model DailyInspection {
  id                    String           @id @default(uuid())
  organizationId        String
  droneId               String
  inspectionType        InspectionType
  executionDate         DateTime
  executionPlaceId      String?
  executorId            String
  
  // 点検項目の結果
  resultAirframe        InspectionResult?
  noteAirframe          String?
  resultPropeller       InspectionResult?
  notePropeller         String?
  resultFrame           InspectionResult?
  noteFrame             String?
  resultMountedEquipment InspectionResult?
  noteMountedEquipment   String?
  resultCommunication   InspectionResult?
  noteCommunication     String?
  resultPropulsion      InspectionResult?
  notePropulsion        String?
  resultPower           InspectionResult?
  notePower             String?
  resultControl         InspectionResult?
  noteControl           String?
  resultController      InspectionResult?
  noteController        String?
  resultBattery         InspectionResult?
  noteBattery           String?
  resultRemoteId        InspectionResult?
  noteRemoteId          String?
  resultLights          InspectionResult?
  noteLights            String?
  resultCamera          InspectionResult?
  noteCamera            String?
  resultPreFlightSnow            InspectionResult?
  notePreFlightSnow              String?
  resultPreFlightAttachment      InspectionResult?
  notePreFlightAttachment        String?
  resultPreFlightDamage          InspectionResult?
  notePreFlightDamage            String?
  resultPreFlightHeat            InspectionResult?
  notePreFlightHeat              String?
  
  specialNote           String?
  overallResult         OverallResult?
  
  retentionUntil        DateTime
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  deletedAt             DateTime?

  organization    Organization @relation(fields: [organizationId], references: [id])
  drone           Drone        @relation(fields: [droneId], references: [id])
  executionPlace  Location?    @relation(fields: [executionPlaceId], references: [id])
  executor        User         @relation(fields: [executorId], references: [id])

  @@index([organizationId])
  @@index([droneId])
  @@index([executionDate])
  @@map("daily_inspections")
}

enum InspectionType {
  PRE_FLIGHT
  POST_FLIGHT
}

enum InspectionResult {
  NORMAL      // 正常
  ABNORMAL    // 異常
  NOT_SELECTED // 未選択
}

enum OverallResult {
  NORMAL
  ABNORMAL
}

// 様式3: 点検整備記録
model MaintenanceRecord {
  id                        String   @id @default(uuid())
  organizationId            String
  droneId                   String
  executionDate             DateTime
  totalFlightTimeAtMoment   Float?
  
  workContent               String
  reason                    String?
  executionPlaceId          String?
  executorId                String
  nextDueNote               String?
  
  retentionUntil            DateTime
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  deletedAt                 DateTime?

  organization    Organization @relation(fields: [organizationId], references: [id])
  drone           Drone        @relation(fields: [droneId], references: [id])
  executionPlace  Location?    @relation(fields: [executionPlaceId], references: [id])
  executor        User         @relation(fields: [executorId], references: [id])

  @@index([organizationId])
  @@index([droneId])
  @@index([executionDate])
  @@map("maintenance_records")
}
